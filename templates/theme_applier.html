<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ThemeQR â€“ Theme & Deck Manager</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme_applier.css') }}">
  <link rel="icon" href="https://themeqr.com/images/TQR_Dude_Sm.png">
</head>
<body>
<header>
  <h1>ThemeQR: Theme & Deck Manager</h1>
  <p>Manage your themes and decks effortlessly.</p>
  {% if user %}
      <div class="auth-controls">
          <span>Hello, {{ user.email }}!</span>
          <a href="{{ url_for('logout') }}" class="logout-btn">Log Out</a>
      </div>
  {% else %}
      <div class="auth-controls">
          <span>Please log in to manage themes and decks.</span>
      </div>
  {% endif %}
</header>

<div class="container">
  <div class="left-panel">
    <h2>Your Decks</h2>
    <div id="deckContainer" class="grid"></div>
  </div>
  <div class="main-panel">
    <h2>QR Code Preview</h2>
    <div id="qrPreview" style="text-align: center; margin-bottom: 2rem;">
      <img id="qrImg" class="qr" src="" alt="QR Code" style="display: none;">
    </div>
  </div>
  <div class="right-panel">
    <h2>Available Themes</h2>
    <div id="themeContainer" class="grid"></div>
  </div>
</div>

<div id="loadingIndicator" class="loading" style="display:none;">Loading data...</div>
<div id="errorDisplay" class="error" style="display:none;">Error: <span id="errorMessage"></span></div>

<footer class="footer">
  &copy; 2025 ThemeQR. All rights reserved.
</footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "{{ supabase_url }}";
  const SUPABASE_KEY = "{{ supabase_key }}";
  const VAULT_ID = "{{ vault_id }}";

  console.log("Supabase URL:", SUPABASE_URL);
  console.log("Supabase Key:", SUPABASE_KEY ? "Set" : "Not set");
  console.log("Vault ID:", VAULT_ID);

  let supabase = null;
  try {
      if (SUPABASE_URL && SUPABASE_URL.startsWith('http') && SUPABASE_KEY) {
          supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
          console.log("Supabase client initialized successfully.");
      } else {
          throw new Error("Supabase URL or Key is invalid or missing.");
      }
  } catch (e) {
      document.getElementById('errorMessage').textContent = `Failed to initialize Supabase: ${e.message}`;
      document.getElementById('errorDisplay').style.display = '';
      console.error("Supabase initialization failed:", e);
  }

  const deckContainer = document.getElementById('deckContainer');
  const themeContainer = document.getElementById('themeContainer');
  const qrImg = document.getElementById('qrImg');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const errorDisplay = document.getElementById('errorDisplay');
  const errorMessageSpan = document.getElementById('errorMessage');

  let allThemes = [];
  let allDecks = [];
  let selectedDeckId = null;

  function showLoading(show) {
      loadingIndicator.style.display = show ? '' : 'none';
      errorDisplay.style.display = 'none';
  }

  function showError(message) {
      errorMessageSpan.textContent = message;
      errorDisplay.style.display = '';
      showLoading(false);
  }

  async function fetchDataFromSupabase(tableName, filter = {}) {
      if (!supabase) {
          showError("Supabase client not initialized.");
          return [];
      }
      try {
          let query = supabase.from(tableName).select('*');
          if (filter.vault_id && filter.vault_id !== "None") {
              console.log("Fetching with vault_id:", filter.vault_id);
              query = query.eq('vault_id', filter.vault_id);
          }
          const { data, error } = await query;
          if (error) throw new Error(error.message);
          console.log(`Fetched ${tableName}:`, data);
          return data || [];
      } catch (error) {
          showError(`Failed to fetch ${tableName}: ${error.message}`);
          return [];
      }
  }

  function populateDecks(decks) {
      deckContainer.innerHTML = '';
      if (decks.length === 0) {
          deckContainer.innerHTML = '<p style="color:#666;">No decks found.</p>';
          return;
      }
      decks.forEach(deck => {
          const deckDiv = document.createElement('div');
          deckDiv.classList.add('deck-item');
          deckDiv.textContent = deck.deck_name || `Deck ID: ${deck.id.substring(0, 8)}...`;
          deckDiv.dataset.deckId = deck.id;
          deckDiv.addEventListener('click', () => selectDeck(deck.id));
          deckContainer.appendChild(deckDiv);
      });
  }

  function populateThemes(themes) {
      themeContainer.innerHTML = '';
      if (themes.length === 0) {
          themeContainer.innerHTML = '<p style="color:#666;">No themes found.</p>';
          return;
      }
      themes.forEach(theme => {
          const themeDiv = document.createElement('div');
          themeDiv.classList.add('theme-item');
          themeDiv.innerHTML = `
              <video controls width="200" height="150">
                  <source src="${theme.wrapper_url}" type="video/mp4">
                  Your browser does not support the video tag.
              </video>
              <span>${theme.name}</span>
              <button class="apply-btn" data-theme-id="${theme.id}">Apply</button>
          `;
          themeDiv.querySelector('.apply-btn').addEventListener('click', () => applyTheme(theme.id));
          themeContainer.appendChild(themeDiv);
      });
  }

  function selectDeck(deckId) {
      selectedDeckId = deckId;
      const selectedDeck = allDecks.find(d => d.id === deckId);
      if (selectedDeck) {
          const qrImageName = `${VAULT_ID}_${selectedDeck.deck_name}_qr.png`;
          qrImg.src = `https://themeqr-backend.onrender.com/static/${qrImageName}?t=${new Date().getTime()}`;
          qrImg.style.display = 'block';
          console.log("Selected deck:", deckId, "QR displayed:", qrImg.src);
      }
  }

  async function applyTheme(themeId) {
      if (!selectedDeckId) {
          showError("Please select a deck first.");
          return;
      }
      showLoading(true);
      try {
          const theme = allThemes.find(t => t.id === themeId);
          if (!theme) throw new Error("Theme not found.");

          // Fetch the deck's current QR image URL
          const selectedDeck = allDecks.find(d => d.id === selectedDeckId);
          const qrImageName = `${VAULT_ID}_${selectedDeck.deck_name}_qr.png`;
          const qrUrl = `https://themeqr-backend.onrender.com/static/${qrImageName}`;

          // Call backend to process and update
          const response = await fetch('/apply_theme', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ deck_id: selectedDeckId, theme_id: themeId, qr_url: qrUrl })
          });
          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
          }
          const result = await response.json();
          if (result.success) {
              showError("Theme applied successfully!");
              // Update local deck data
              const updatedDeck = allDecks.find(d => d.id === selectedDeckId);
              updatedDeck.wrapper = result.new_wrapper_url;
              updatedDeck.landing_url = theme.landing_url;
              selectDeck(selectedDeckId); // Refresh QR to reflect new state
          } else {
              showError(result.error || "Failed to apply theme.");
          }
      } catch (error) {
          showError(`Error applying theme: ${error.message}`);
      } finally {
          showLoading(false);
      }
  }

  document.addEventListener('DOMContentLoaded', async () => {
      showLoading(true);
      try {
          allThemes = await fetchDataFromSupabase('themes');
          populateThemes(allThemes);
          if (VAULT_ID && VAULT_ID !== "None") {
              console.log("Using vault_id:", VAULT_ID);
              allDecks = await fetchDataFromSupabase('decks', { vault_id: VAULT_ID });
              populateDecks(allDecks);
          } else {
              deckContainer.innerHTML = '<p style="color:#666;">No vault assigned. Please ensure you are logged in and contact support.</p>';
              console.warn("VAULT_ID is invalid or missing:", VAULT_ID);
          }
      } catch (e) {
          showError(`Failed to load initial data: ${e.message}`);
      } finally {
          showLoading(false);
      }
  });
</script>
</body>
</html>