<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ThemeQR â€“ Theme & Deck Manager</title>
  <link rel="stylesheet" href="/static/css/theme_applier.css">
  <link rel="icon" href="https://themeqr.com/images/TQR_Dude_Sm.png">
</head>
<body>
<header>
  <h1>ThemeQR: Theme & Deck Manager</h1>
  <p>Manage your themes and decks effortlessly.</p>
  <div class="header-bottom">
    <nav class="header-nav">
      <a href="/manager">Manager</a> |
      <a href="/themes">Themes</a> |
      <a href="/decks">Decks</a>
    </nav>
    <div class="auth-controls">
      <span>Hello, mrsbdkelmon@gmail.com!</span>
      <a href="/logout" class="logout-btn">Log Out</a>
    </div>
  </div>
</header>

<div class="main-panel">
  <h2>QR Code Preview</h2>
  <div id="qrPreview" class="qr-preview">
    <img id="qrImg" class="qr" src="" alt="QR Code" style="display: none;">
  </div>
</div>

<div class="container">
  <div class="left-panel">
    <h2>Your Decks</h2>
    <div id="deckContainer" class="grid"></div>
  </div>
  <div class="right-panel">
    <h2>Available Themes</h2>
    <div id="themeContainer" class="grid"></div>
  </div>
</div>

<div id="loadingIndicator" class="loading" style="display:none;">Loading data...</div>
<div id="errorDisplay" class="error" style="display:none;">Error: <span id="errorMessage"></span></div>

<footer class="footer">
  &copy; 2025 ThemeQR. All rights reserved.
</footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "https://hvfqdrfdefgfqbfdikpn.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2ZnFkcmZkZWZnZnFiZmRpa3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxOTA4MjgsImV4cCI6MjA2Nzc2NjgyOH0.nG8rzVCQR6J8XxbTaiC9zOUjFu7fi-4oRVY-D61NCJU";
  const VAULT_ID = "6d570fa1-9ae3-4ecb-82d5-e1494ae3e404";

  console.log("Supabase URL:", SUPABASE_URL);
  console.log("Supabase Key:", SUPABASE_KEY ? "Set" : "Not set");
  console.log("Vault ID:", VAULT_ID);

  let supabase = null;
  try {
      if (SUPABASE_URL && SUPABASE_URL.startsWith('http') && SUPABASE_KEY) {
          supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
          console.log("Supabase client initialized successfully.");
      } else {
          throw new Error("Supabase URL or Key is invalid or missing.");
      }
  } catch (e) {
      document.getElementById('errorMessage').textContent = `Failed to initialize Supabase: ${e.message}`;
      document.getElementById('errorDisplay').style.display = '';
      console.error("Supabase initialization failed:", e);
  }

  const deckContainer = document.getElementById('deckContainer');
  const themeContainer = document.getElementById('themeContainer');
  const qrImg = document.getElementById('qrImg');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const errorDisplay = document.getElementById('errorDisplay');
  const errorMessageSpan = document.getElementById('errorMessage');

  let allThemes = [];
  let allDecks = [];
  let selectedDeckId = null;

  function showLoading(show) {
      loadingIndicator.style.display = show ? '' : 'none';
      errorDisplay.style.display = 'none';
  }

  function showError(message) {
      errorMessageSpan.textContent = message;
      errorDisplay.style.display = '';
      showLoading(false);
  }

  async function fetchDataFromSupabase(tableName, filter = {}) {
      if (!supabase) {
          showError("Supabase client not initialized.");
          return [];
      }
      try {
          let query = supabase.from(tableName).select('*');
          if (filter.vault_id && filter.vault_id !== "None") {
              console.log("Fetching with vault_id:", filter.vault_id);
              query = query.eq('vault_id', filter.vault_id);
          }
          const { data, error } = await query;
          if (error) throw new Error(error.message);
          console.log(`Fetched ${tableName}:`, data);
          return data || [];
      } catch (error) {
          showError(`Failed to fetch ${tableName}: ${error.message}`);
          return [];
      }
  }

  function populateDecks(decks) {
      deckContainer.innerHTML = '';
      if (decks.length === 0) {
          deckContainer.innerHTML = '<p style="color:#666;">No decks found.</p>';
          return;
      }
      decks.forEach(deck => {
          const deckDiv = document.createElement('div');
          deckDiv.classList.add('deck-item', 'apply-btn'); /* Apply button style to deck items */
          deckDiv.textContent = deck.deck_name || `Deck ID: ${deck.id.substring(0, 8)}...`;
          deckDiv.dataset.deckId = deck.id;
          deckDiv.addEventListener('click', () => selectDeck(deck.id));
          deckContainer.appendChild(deckDiv);
      });
  }

function populateThemes(themes) {
  themeContainer.innerHTML = '';
  if (themes.length === 0) {
    themeContainer.innerHTML = '<p style="color:#666;">No themes found.</p>';
    return;
  }

  themes.forEach(theme => {
    const themeDiv = document.createElement('div');
    themeDiv.classList.add('theme-item');

    const videoContent = theme.wrapper_url.includes('player.cloudinary.com')
      ? `
        <div class="video-wrapper">
          <div class="video-section">
            <iframe id="video-${theme.id}" class="theme-video" width="200" height="150"
                    src="${theme.wrapper_url}"
                    frameborder="0"
                    allow="autoplay; encrypted-media"
                    allowfullscreen
                    style="display:block;">
            </iframe>
          </div>
          <div class="button-section">
            <button class="apply-btn" data-theme-id="${theme.id}">Apply</button>
          </div>
        </div>`
      : `
        <div class="video-wrapper">
          <div class="video-section">
            <!-- NOTE: no <source> tag; we set .src in JS -->
            <video id="video-${theme.id}" class="theme-video" width="200" height="150"
                   style="display:none;"
                   muted
                   playsinline
                   controls
                   preload="metadata">
            </video>
            <div id="no-video-${theme.id}" class="no-video" style="display:none; color:red;">No Video</div>
          </div>
          <div class="button-section">
            <button class="apply-btn" data-theme-id="${theme.id}">Apply</button>
          </div>
        </div>`;

    themeDiv.innerHTML = `
      <div class="theme-header">
        <span class="theme-name">${theme.name}</span>
      </div>
      ${videoContent}
    `;
    themeContainer.appendChild(themeDiv);

    const applyButton = themeDiv.querySelector('.apply-btn');
    if (applyButton) {
      applyButton.addEventListener('click', () => applyTheme(theme.id));
    }

    // Only wire up <video> if we're not using the Cloudinary player iframe
    if (!theme.wrapper_url.includes('player.cloudinary.com')) {
      const video = document.getElementById(`video-${theme.id}`);
      const noVideo = document.getElementById(`no-video-${theme.id}`);

      video.addEventListener('error', () => {
        video.style.display = 'none';
        noVideo.style.display = 'block';
      }, { once: true });

      // Show once it can play; start playback once
      video.addEventListener('canplay', () => {
        video.style.display = 'block';
        noVideo.style.display = 'none';
        // Optional smooth looping:
        // video.loop = true;
        video.play().catch(() => {/* autoplay may be blocked if not muted */});
      }, { once: true });

      // Set src AFTER attributes are in place
      video.src = theme.wrapper_url;
    }
  });
}

  function selectDeck(deckId) {
      selectedDeckId = deckId;
      const selectedDeck = allDecks.find(d => d.id === deckId);
      if (selectedDeck) {
          const qrImageName = `${VAULT_ID}_${selectedDeck.deck_name}_qr.png`;
          qrImg.src = `https://themeqr-backend.onrender.com/static/${qrImageName}?t=${new Date().getTime()}`;
          qrImg.style.display = 'block';
          console.log("Selected deck:", deckId, "QR displayed:", qrImg.src);
      }
  }

  async function applyTheme(themeId) {
      if (!selectedDeckId) {
          showError("Please select a deck first.");
          return;
      }
      showLoading(true);
      try {
          const theme = allThemes.find(t => t.id === themeId);
          if (!theme) throw new Error("Theme not found.");

          const response = await fetch('/apply_theme', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ deck_id: selectedDeckId, theme_id: themeId, qr_url: qrImg.src })
          });
          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
          }
          const result = await response.json();
          if (result.success) {
              showError("Theme applied successfully!");
              const updatedDeck = allDecks.find(d => d.id === selectedDeckId);
              updatedDeck.wrapper = theme.wrapper_url;
              updatedDeck.landing_url = theme.landing_url;
              selectDeck(selectedDeckId);
          } else {
              showError(result.error || "Failed to apply theme.");
          }
      } catch (error) {
          showError(`Error applying theme: ${error.message}`);
      } finally {
          showLoading(false);
      }
  }

  document.addEventListener('DOMContentLoaded', async () => {
      showLoading(true);
      try {
          allThemes = await fetchDataFromSupabase('themes');
          populateThemes(allThemes);
          if (VAULT_ID && VAULT_ID !== "None") {
              console.log("Using vault_id:", VAULT_ID);
              allDecks = await fetchDataFromSupabase('decks', { vault_id: VAULT_ID });
              populateDecks(allDecks);
          } else {
              deckContainer.innerHTML = '<p style="color:#666;">No vault assigned. Please ensure you are logged in and contact support.</p>';
              console.warn("VAULT_ID is invalid or missing:", VAULT_ID);
          }
      } catch (e) {
          showError(`Failed to load initial data: ${e.message}`);
      } finally {
          showLoading(false);
      }
  });
</script>
</body>
</html>