<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ThemeQR â€“ Theme & Deck Manager</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme_applier.css') }}">
  <link rel="icon" href="https://themeqr.com/images/TQR_Dude_Sm.png">
</head>
<body> 
<header>
  <h1>ThemeQR: Theme & Deck Manager</h1>
  <p>Manage your themes and decks effortlessly.</p>
  {% if user %}
      <div class="auth-controls">
          <span>Hello, {{ user.email }}!</span>
          <a href="{{ url_for('logout') }}" class="logout-btn">Log Out</a>
      </div>
  {% else %}
      <div class="auth-controls">
          <span>Please log in to manage themes and decks.</span>
      </div>
  {% endif %}
</header>

<div class="section">
  <h2>Available Themes</h2>
  <div id="themeFoldersContainer" class="grid"></div>
  <div id="themeDetailsSection" class="details-section" style="display:none;">
    <h3>Selected Theme Details: <span id="selectedThemeName"></span></h3>
    <pre id="themeDetailsDisplay">Select a theme to see its details.</pre>
    <button id="applyThemeToDeckButton" class="btn">Apply Theme to Deck</button>
  </div>
</div>

<div class="section">
  <h2>Your Decks</h2>
  <div id="deckFoldersContainer" class="grid"></div>
  <div id="deckDetailsSection" class="details-section" style="display:none;">
    <h3>Selected Deck Details: <span id="selectedDeckName"></span></h3>
    <pre id="deckDetailsDisplay">Select a deck to see its details.</pre>
  </div>
</div>

<div id="loadingIndicator" class="loading" style="display:none;">Loading data...</div>
<div id="errorDisplay" class="error" style="display:none;">Error: <span id="errorMessage"></span></div>

<!-- Apply Theme to Deck Modal -->
<div id="applyThemeToDeckModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Apply Theme "<span id="modalThemeToDeckName"></span>"</h3>
      <button class="modal-close-button" id="closeThemeToDeckModalButton">&times;</button>
    </div>
    <div>
      <label for="themeToDeckSelect">Select a Deck:</label>
      <select id="themeToDeckSelect" style="width:100%;padding:0.5rem;"></select>
    </div>
    <button id="confirmApplyThemeToDeckButton" class="btn">Confirm Apply</button>
    <div id="applyThemeToDeckLoadingIndicator" class="loading" style="display:none;">Applying theme to deck...</div>
    <div id="applyThemeToDeckErrorDisplay" class="error" style="display:none;">Error: <span id="applyThemeToDeckErrorMessage"></span></div>
  </div>
</div>

<footer class="footer">
  &copy; 2025 ThemeQR. All rights reserved.
</footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // Supabase configuration passed from Flask
  const SUPABASE_URL = "{{ supabase_url }}";
  const SUPABASE_KEY = "{{ supabase_key }}";

  let supabase = null;
  try {
      if (SUPABASE_URL && SUPABASE_URL.startsWith('http')) {
          supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
          console.log("Supabase client initialized.");
      } else {
          const errorMessage = "Supabase URL is invalid or missing. Please ensure Flask passes a valid URL.";
          console.error(errorMessage, "URL:", SUPABASE_URL);
          document.getElementById('errorMessage').textContent = errorMessage;
          document.getElementById('errorDisplay').classList.remove('hidden');
      }
  } catch (e) {
      const errorMessage = `Failed to initialize Supabase client: ${e.message}`;
      console.error(errorMessage, e);
      document.getElementById('errorMessage').textContent = errorMessage;
      document.getElementById('errorDisplay').classList.remove('hidden');
  }

  // --- DOM Elements (Themes) ---
  const themeFoldersContainer = document.getElementById('themeFoldersContainer');
  const themeDetailsSection = document.getElementById('themeDetailsSection');
  const selectedThemeNameSpan = document.getElementById('selectedThemeName');
  const themeDetailsDisplay = document.getElementById('themeDetailsDisplay');
  const applyThemeToDeckButton = document.getElementById('applyThemeToDeckButton');

  // --- DOM Elements (Decks) ---
  const deckFoldersContainer = document.getElementById('deckFoldersContainer');
  const deckDetailsSection = document.getElementById('deckDetailsSection');
  const selectedDeckNameSpan = document.getElementById('selectedDeckName');
  const deckDetailsDisplay = document.getElementById('deckDetailsDisplay');

  // --- General Indicators ---
  const loadingIndicator = document.getElementById('loadingIndicator');
  const errorDisplay = document.getElementById('errorDisplay');
  const errorMessageSpan = document.getElementById('errorMessage');

  // --- Theme to Deck Modal Elements ---
  const applyThemeToDeckModal = document.getElementById('applyThemeToDeckModal');
  const closeThemeToDeckModalButton = document.getElementById('closeThemeToDeckModalButton');
  const modalThemeToDeckNameSpan = document.getElementById('modalThemeToDeckName');
  const themeToDeckSelect = document.getElementById('themeToDeckSelect');
  const confirmApplyThemeToDeckButton = document.getElementById('confirmApplyThemeToDeckButton');
  const applyThemeToDeckLoadingIndicator = document.getElementById('applyThemeToDeckLoadingIndicator');
  const applyThemeToDeckErrorDisplay = document.getElementById('applyThemeToDeckErrorDisplay');
  const applyThemeToDeckErrorMessageSpan = document.getElementById('applyThemeToDeckErrorMessage');

  let allThemes = [];
  let allDecks = [];
  let selectedTheme = null;
  let selectedDeck = null;

  // --- Helper Functions ---
  function showLoading(show, target = 'main') {
      const indicator = {
          'main': loadingIndicator,
          'applyThemeToDeck': applyThemeToDeckLoadingIndicator
      }[target];
      const errorDiv = {
          'main': errorDisplay,
          'applyThemeToDeck': applyThemeToDeckErrorDisplay
      }[target];
      if (show) {
          indicator.style.display = '';
          errorDiv.style.display = 'none';
      } else {
          indicator.style.display = 'none';
      }
  }

  function showError(message, target = 'main') {
      const errorSpan = {
          'main': errorMessageSpan,
          'applyThemeToDeck': applyThemeToDeckErrorMessageSpan
      }[target];
      const errorDiv = {
          'main': errorDisplay,
          'applyThemeToDeck': applyThemeToDeckErrorDisplay
      }[target];
      errorSpan.textContent = message;
      errorDiv.style.display = '';
      showLoading(false, target);
  }

  async function fetchDataFromSupabase(tableName, filter = {}) {
      if (!supabase) {
          showError("Supabase client not initialized. Cannot fetch data.", 'main');
          return [];
      }
      try {
          let query = supabase.from(tableName).select('*');
          if (filter.vault_id) {
              query = query.eq('vault_id', filter.vault_id);
          }
          const { data, error } = await query;
          if (error) throw new Error(error.message);
          return data || [];
      } catch (error) {
          console.error(`Error fetching data from ${tableName}:`, error.message);
          showError(`Failed to fetch ${tableName}: ${error.message}`, 'main');
          return [];
      }
  }

  function populateThemeFolders(themes) {
      themeFoldersContainer.innerHTML = '';
      if (themes.length === 0) {
          themeFoldersContainer.innerHTML = '<p style="color:#666;">No themes found.</p>';
          return;
      }
      themes.forEach(theme => {
          const themeCard = document.createElement('div');
          themeCard.classList.add('item-card');
          themeCard.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-4.5-7.5l-2.25 2.25M9.75 4.5l-2.25 2.25M3.75 12l-.75.75-.75-.75M2.25 12.75a3 3 0 003 3h13.5a3 3 0 003-3M6.75 12l-.75.75-.75-.75M17.25 12l.75.75.75-.75M2.25 12.75a3 3 0 003 3h13.5a3 3 0 003-3M6.75 12l-.75.75-.75-.75M17.25 12l.75.75.75-.75M12 10.5h.008v.008H12V10.5zm0 3h.008v.008H12v-3zm0 3h.008v.008H12v-3z" />
              </svg>
              <span class="item-card-name">${theme.name}</span>
          `;
          themeCard.dataset.themeId = theme.id;
          themeCard.addEventListener('click', () => selectTheme(theme.id));
          themeFoldersContainer.appendChild(themeCard);
      });
  }

  function populateDeckFolders(decks) {
      deckFoldersContainer.innerHTML = '';
      if (decks.length === 0) {
          deckFoldersContainer.innerHTML = '<p style="color:#666;">No decks found.</p>';
          return;
      }
      decks.forEach(deck => {
          const deckCard = document.createElement('div');
          deckCard.classList.add('item-card');
          deckCard.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-4.5-7.5l-2.25 2.25M9.75 4.5l-2.25 2.25M3.75 12l-.75.75-.75-.75M2.25 12.75a3 3 0 003 3h13.5a3 3 0 003-3M6.75 12l-.75.75-.75-.75M17.25 12l.75.75.75-.75M2.25 12.75a3 3 0 003 3h13.5a3 3 0 003-3M6.75 12l-.75.75-.75-.75M17.25 12l.75.75.75-.75M12 10.5h.008v.008H12V10.5zm0 3h.008v.008H12v-3zm0 3h.008v.008H12v-3z" />
              </svg>
              <span class="item-card-name">${deck.deck_name || `Deck ID: ${deck.id.substring(0, 8)}...`}</span>
          `;
          deckCard.dataset.deckId = deck.id;
          deckCard.addEventListener('click', () => selectDeck(deck.id));
          deckFoldersContainer.appendChild(deckCard);
      });
  }

  function selectTheme(themeId) {
      document.querySelectorAll('#themeFoldersContainer .item-card').forEach(card => card.classList.remove('selected'));
      const selectedCard = document.querySelector(`#themeFoldersContainer .item-card[data-theme-id="${themeId}"]`);
      if (selectedCard) selectedCard.classList.add('selected');
      selectedTheme = allThemes.find(theme => theme.id === themeId);
      if (selectedTheme) {
          selectedThemeNameSpan.textContent = selectedTheme.name;
          themeDetailsDisplay.textContent = JSON.stringify(selectedTheme, null, 2);
          themeDetailsSection.style.display = '';
      } else {
          themeDetailsSection.style.display = 'none';
          themeDetailsDisplay.textContent = 'Select a theme to see its details.';
      }
  }

  function selectDeck(deckId) {
      document.querySelectorAll('#deckFoldersContainer .item-card').forEach(card => card.classList.remove('selected'));
      const selectedCard = document.querySelector(`#deckFoldersContainer .item-card[data-deck-id="${deckId}"]`);
      if (selectedCard) selectedCard.classList.add('selected');
      selectedDeck = allDecks.find(deck => deck.id === deckId);
      if (selectedDeck) {
          selectedDeckNameSpan.textContent = selectedDeck.deck_name || `Deck ID: ${selectedDeck.id.substring(0, 8)}...`;
          deckDetailsDisplay.textContent = JSON.stringify(selectedDeck, null, 2);
          deckDetailsSection.style.display = '';
      } else {
          deckDetailsSection.style.display = 'none';
          deckDetailsDisplay.textContent = 'Select a deck to see its details.';
      }
  }

  function populateThemeToDeckSelect(decks) {
      themeToDeckSelect.innerHTML = '';
      if (decks.length === 0) {
          themeToDeckSelect.innerHTML = '<option value="">No decks found.</option>';
          themeToDeckSelect.disabled = true;
          confirmApplyThemeToDeckButton.disabled = true;
          return;
      }
      const defaultOption = document.createElement('option');
      defaultOption.value = "";
      defaultOption.textContent = "--- Select a deck ---";
      themeToDeckSelect.appendChild(defaultOption);
      decks.forEach(deck => {
          const option = document.createElement('option');
          option.value = deck.id;
          option.textContent = deck.deck_name || `Deck ID: ${deck.id.substring(0, 8)}...`;
          themeToDeckSelect.appendChild(option);
      });
      themeToDeckSelect.disabled = false;
      confirmApplyThemeToDeckButton.disabled = false;
  }

  async function openApplyThemeToDeckModal() {
      if (!selectedTheme) {
          showError("Please select a theme first.", 'main');
          return;
      }
      modalThemeToDeckNameSpan.textContent = selectedTheme.name;
      applyThemeToDeckModal.style.display = 'flex';
      applyThemeToDeckErrorDisplay.style.display = 'none';
      showLoading(true, 'applyThemeToDeck');
      allDecks = await fetchDataFromSupabase('decks', { vault_id: "{{ user.vault_id or user.id }}" });
      populateThemeToDeckSelect(allDecks);
      showLoading(false, 'applyThemeToDeck');
  }

  function closeApplyThemeToDeckModal() {
      applyThemeToDeckModal.style.display = 'none';
  }

  async function confirmApplyThemeToDeck() {
      const selectedDeckId = themeToDeckSelect.value;
      if (!selectedDeckId) {
          showError("Please select a deck.", 'applyThemeToDeck');
          return;
      }
      if (!selectedTheme) {
          showError("No theme selected. This should not happen.", 'applyThemeToDeck');
          return;
      }
      showLoading(true, 'applyThemeToDeck');
      applyThemeToDeckErrorDisplay.style.display = 'none';
      try {
          const response = await fetch('/apply_theme_to_deck', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  theme_id: selectedTheme.id,
                  deck_id: selectedDeckId,
                  wrapper_url: selectedTheme.wrapper_url, // Replace deck's wrapper
                  landing_url: selectedTheme.landing_url  // Replace deck's landing_url
              })
          });
          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
          }
          const result = await response.json();
          if (result.success) {
              showError("Theme applied to deck successfully!", 'applyThemeToDeck');
              setTimeout(closeApplyThemeToDeckModal, 2000);
              allDecks = await fetchDataFromSupabase('decks', { vault_id: "{{ user.vault_id or user.id }}" });
              populateDeckFolders(allDecks);
              selectDeck(selectedDeckId);
          } else {
              showError(result.error || "Failed to apply theme.", 'applyThemeToDeck');
          }
      } catch (error) {
          console.error("Error applying theme to deck:", error);
          showError(`Error applying theme: ${error.message}`, 'applyThemeToDeck');
      } finally {
          showLoading(false, 'applyThemeToDeck');
      }
  }

  // --- Event Listeners ---
  applyThemeToDeckButton.addEventListener('click', openApplyThemeToDeckModal);
  closeThemeToDeckModalButton.addEventListener('click', closeApplyThemeToDeckModal);
  confirmApplyThemeToDeckButton.addEventListener('click', confirmApplyThemeToDeck);

  // --- Initial Load ---
  document.addEventListener('DOMContentLoaded', async () => {
      showLoading(true, 'main');
      allThemes = await fetchDataFromSupabase('themes');
      populateThemeFolders(allThemes);
      if ("{{ user }}" !== "None") {
          allDecks = await fetchDataFromSupabase('decks', { vault_id: "{{ user.vault_id or user.id }}" });
          populateDeckFolders(allDecks);
      } else {
          deckFoldersContainer.innerHTML = '<p style="color:#666;">Please log in to see your decks.</p>';
      }
      showLoading(false, 'main');
  });
</script>
</body>
</html>