 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ThemeQR â€“ Theme & Deck Manager</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme_applier.css') }}">
  <link rel="icon" href="https://themeqr.com/images/TQR_Dude_Sm.png">
</head>
<body>
<header>
  <h1>ThemeQR: Theme & Deck Manager</h1>
  <p>Manage your themes and decks effortlessly.</p>
  {% if user %}
      <div class="auth-controls">
          <span>Hello, {{ user.email }}!</span>
          <a href="{{ url_for('logout') }}" class="logout-btn">Log Out</a>
      </div>
  {% else %}
      <div class="auth-controls">
          <span>Please log in to manage themes and decks.</span>
      </div>
  {% endif %}
</header>

<div class="section">
  <h2>Available Themes</h2>
  <div id="themeContainer" class="grid"></div>
</div>

<div class="section">
  <h2>Your Decks</h2>
  <div id="deckContainer" class="grid"></div>
</div>

<div id="loadingIndicator" class="loading" style="display:none;">Loading data...</div>
<div id="errorDisplay" class="error" style="display:none;">Error: <span id="errorMessage"></span></div>

<!-- Select Deck Modal -->
<div id="selectDeckModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Apply Theme "<span id="modalThemeName"></span>" to Deck</h3>
      <button class="modal-close-button" id="closeSelectDeckModalButton">&times;</button>
    </div>
    <div>
      <label for="deckSelect">Select a Deck:</label>
      <select id="deckSelect" style="width:100%;padding:0.5rem;"></select>
    </div>
    <button id="confirmDeckSelectionButton" class="btn">Confirm</button>
    <div id="selectDeckLoadingIndicator" class="loading" style="display:none;">Applying theme...</div>
    <div id="selectDeckErrorDisplay" class="error" style="display:none;">Error: <span id="selectDeckErrorMessage"></span></div>
  </div>
</div>

<footer class="footer">
  &copy; 2025 ThemeQR. All rights reserved.
</footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "{{ supabase_url }}";
  const SUPABASE_KEY = "{{ supabase_key }}";
  
  console.log("Supabase URL:", SUPABASE_URL);
  console.log("Supabase Key:", SUPABASE_KEY ? "Set" : "Not set");

  let supabase = null;
  try {
      if (SUPABASE_URL && SUPABASE_URL.startsWith('http') && SUPABASE_KEY) {
          supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
          console.log("Supabase client initialized.");
      } else {
          throw new Error("Supabase URL is invalid or missing.");
      }
  } catch (e) {
      document.getElementById('errorMessage').textContent = `Failed to initialize Supabase: ${e.message}`;
      document.getElementById('errorDisplay').style.display = '';
  }

  const themeContainer = document.getElementById('themeContainer');
  const deckContainer = document.getElementById('deckContainer');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const errorDisplay = document.getElementById('errorDisplay');
  const errorMessageSpan = document.getElementById('errorMessage');
  const selectDeckModal = document.getElementById('selectDeckModal');
  const closeSelectDeckModalButton = document.getElementById('closeSelectDeckModalButton');
  const modalThemeNameSpan = document.getElementById('modalThemeName');
  const deckSelect = document.getElementById('deckSelect');
  const confirmDeckSelectionButton = document.getElementById('confirmDeckSelectionButton');
  const selectDeckLoadingIndicator = document.getElementById('selectDeckLoadingIndicator');
  const selectDeckErrorDisplay = document.getElementById('selectDeckErrorDisplay');
  const selectDeckErrorMessageSpan = document.getElementById('selectDeckErrorMessage');

  let allThemes = [];
  let allDecks = [];

  function showLoading(show) {
      loadingIndicator.style.display = show ? '' : 'none';
      errorDisplay.style.display = 'none';
  }

  function showError(message) {
      errorMessageSpan.textContent = message;
      errorDisplay.style.display = '';
      showLoading(false);
  }

  async function fetchDataFromSupabase(tableName, filter = {}) {
      if (!supabase) {
          showError("Supabase client not initialized.");
          return [];
      }
      try {
          let query = supabase.from(tableName).select('*');
          if (filter.vault_id) query = query.eq('vault_id', filter.vault_id);
          const { data, error } = await query;
          if (error) throw new Error(error.message);
          return data || [];
      } catch (error) {
          showError(`Failed to fetch ${tableName}: ${error.message}`);
          return [];
      }
  }

  function populateThemes(themes) {
      themeContainer.innerHTML = '';
      if (themes.length === 0) {
          themeContainer.innerHTML = '<p style="color:#666;">No themes found.</p>';
          return;
      }
      themes.forEach(theme => {
          const themeDiv = document.createElement('div');
          themeDiv.classList.add('theme-item');
          themeDiv.innerHTML = `
              <span>${theme.name}</span>
              <button class="apply-btn" data-theme-id="${theme.id}">Apply</button>
          `;
          themeContainer.appendChild(themeDiv);
      });
      document.querySelectorAll('.apply-btn').forEach(btn =>
          btn.addEventListener('click', () => openSelectDeckModal(theme.id))
      );
  }

  function populateDecks(decks) {
      deckContainer.innerHTML = '';
      if (decks.length === 0) {
          deckContainer.innerHTML = '<p style="color:#666;">No decks found.</p>';
          return;
      }
      decks.forEach(deck => {
          const deckDiv = document.createElement('div');
          deckDiv.classList.add('deck-item');
          deckDiv.textContent = deck.deck_name || `Deck ID: ${deck.id.substring(0, 8)}...`;
          deckContainer.appendChild(deckDiv);
      });
  }

  function populateDeckSelect(decks) {
      deckSelect.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = "";
      defaultOption.textContent = "--- Select a deck ---";
      deckSelect.appendChild(defaultOption);
      decks.forEach(deck => {
          const option = document.createElement('option');
          option.value = deck.id;
          option.textContent = deck.deck_name || `Deck ID: ${deck.id.substring(0, 8)}...`;
          deckSelect.appendChild(option);
      });
  }

  function openSelectDeckModal(themeId) {
      const theme = allThemes.find(t => t.id === themeId);
      if (!theme) {
          showError("Theme not found.");
          return;
      }
      modalThemeNameSpan.textContent = theme.name;
      selectDeckModal.style.display = 'flex';
      selectDeckErrorDisplay.style.display = 'none';
      populateDeckSelect(allDecks);
  }

  function closeSelectDeckModal() {
      selectDeckModal.style.display = 'none';
  }

  async function confirmDeckSelection() {
      const selectedDeckId = deckSelect.value;
      const themeId = modalThemeNameSpan.dataset.themeId;
      if (!selectedDeckId || !themeId) {
          showError("Please select a deck and ensure a theme is chosen.");
          return;
      }
      showLoading(true);
      selectDeckErrorDisplay.style.display = 'none';
      try {
          const response = await fetch('/apply_theme_to_deck', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ theme_id: themeId, deck_id: selectedDeckId })
          });
          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
          }
          const result = await response.json();
          if (result.success) {
              showError("Theme applied to deck successfully!");
              setTimeout(closeSelectDeckModal, 2000);
              allDecks = await fetchDataFromSupabase('decks', { vault_id: "{{ user.vault_id or user.id }}" });
              populateDecks(allDecks);
          } else {
              showError(result.error || "Failed to apply theme.");
          }
      } catch (error) {
          showError(`Error applying theme: ${error.message}`);
      } finally {
          showLoading(false);
      }
  }

  document.addEventListener('DOMContentLoaded', async () => {
      showLoading(true);
      try {
          allThemes = await fetchDataFromSupabase('themes');
          populateThemes(allThemes);
          if ("{{ user }}" !== "None") {
              allDecks = await fetchDataFromSupabase('decks', { vault_id: "{{ user.vault_id or user.id }}" });
              populateDecks(allDecks);
          } else {
              deckContainer.innerHTML = '<p style="color:#666;">Please log in to see your decks.</p>';
          }
      } catch (e) {
          showError(`Failed to load initial data: ${e.message}`);
      } finally {
          showLoading(false);
      }
  });

  closeSelectDeckModalButton.addEventListener('click', closeSelectDeckModal);
  confirmDeckSelectionButton.addEventListener('click', confirmDeckSelection);
</script>
</body>
</html>