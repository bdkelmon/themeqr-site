<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ThemeQR — Studio</title>
  <link rel="icon" href="https://themeqr.com/images/TQR_Dude_Sm.png" />
  <style>
    :root {
      --bg: #0f1220;
      --panel: #171a2b;
      --muted: #8c93b2;
      --text: #e8ebff;
      --accent: #6c7dff;
      --accent-2: #2de6c5;
      --danger: #ff6b6b;
      --radius: 14px;
      --radius-sm: 10px;
      --shadow: 0 10px 30px rgba(0, 0, 0, .35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 70% -10%, #4fc724 0%, #0f1220 55%) fixed;
      color: var(--text);
      font-family: var(--sans);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 18px 22px;
      border-bottom: 1px solid #232741;
      background: linear-gradient(180deg, #15182a, #12162a);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .logo {
      display: flex;
      gap: 12px;
      align-items: center;
      font-weight: 700
    }

    main {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 18px;
      padding: 18px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Left sidebar nav */
    aside#sidebar {
      background: var(--panel);
      border: 1px solid #232741;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      height: calc(100vh - 110px);
      position: sticky;
      top: 90px;
      overflow: auto;
    }

    .nav-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px
    }

    .nav-title {
      font-size: 12px;
      color: #aab1d6;
      text-transform: uppercase;
      letter-spacing: .06em;
      margin: 4px 6px
    }

    .nav-btn {
      display: block;
      width: 100%;
      text-align: left;
      background: #1b1f35;
      color: var(--text);
      border: 1px solid #262a45;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      text-decoration: none;
    }

    .nav-btn.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(108, 125, 255, .25) inset;
    }

    .nav-btn.link {
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .nav-btn small {
      color: #aab1d6
    }

    /* Content panel */
    section#content {
      background: rgba(18, 22, 43, .65);
      backdrop-filter: saturate(110%) blur(6px);
      border: 1px solid #232741;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-height: 480px;
    }

    .pad {
      padding: 16px
    }

    h2 {
      margin: 8px 0 14px 0;
      font-size: 18px
    }

    .muted {
      color: var(--muted)
    }

    .small {
      font-size: 12px
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin: 14px 0 6px
    }

    input[type="text"],
    input[type="url"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #2a2e4d;
      background: #13182e;
      color: var(--text);
      border-radius: 10px;
      font-size: 14px;
    }

    textarea {
      min-height: 70px;
      resize: vertical
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }

    .row>div {
      flex: 1
    }

    .btn {
      appearance: none;
      border: 1px solid #2b2f4e;
      background: #171b34;
      color: #e8ebff;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
    }

    .btn.primary {
      background: linear-gradient(180deg, #3b47ff, #6c7dff);
      border-color: #5563ff
    }

    .btn.ghost {
      background: #13182e
    }

    .btn.warn {
      border-color: var(--danger);
      color: #ffd6d6
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed
    }

    .stack {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center
    }

    .code {
      font-family: var(--mono);
      background: #0b0f23;
      border: 1px solid #262a45;
      border-radius: 8px;
      padding: 6px 8px;
      display: inline-block
    }

    .pill {
      padding: 6px 8px;
      border: 1px solid #262a45;
      border-radius: 999px;
      background: #121632
    }

    /* QR Studio layout fixes */
    .qr-wrap {
      display: grid;
      grid-template-columns: minmax(220px, 260px) 1fr;
      gap: 12px;
      align-items: start
    }

    .qr-box {
      display: grid;
      place-items: center;
      background: #0b0f23;
      border: 1px solid #232741;
      border-radius: 12px;
      padding: 12px;
      min-height: 240px
    }

    #qrCanvas {
      width: 220px
    }

    #qrCanvas canvas,
    #qrCanvas img {
      width: 100% !important;
      height: auto !important;
      display: block
    }

    /* Overlay workspace */
    #overlayStage {
      position: relative;
      background: #0b0f23;
      border-radius: var(--radius);
      border: 1px solid #232741;
      overflow: hidden;
      min-height: 420px;
      display: grid;
      place-items: center;
    }

    #overlayStage .placard {
      color: #92a1ff
    }

    #canvasBg {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center
    }

    #canvasBg img,
    #canvasBg video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block
    }

    .floating-qr {
      position: absolute;
      left: 20px;
      top: 20px;
      width: 180px;
      height: 180px;
      cursor: move;
      display: grid;
      place-items: center;
      background: transparent;
      user-select: none;
    }

    .floating-qr.resizing {
      outline: 2px dashed #6c7dff
    }

    .resize-handle {
      position: absolute;
      right: -8px;
      bottom: -8px;
      width: 16px;
      height: 16px;
      background: #6c7dff;
      border-radius: 4px;
      cursor: nwse-resize;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .4);
    }

    /* Theme preview */
    .theme-card {
      border: 1px solid #2a2e4d;
      border-radius: 12px;
      overflow: hidden;
      background: #0d1130
    }

    .theme-card header {
      padding: 10px 12px;
      border-bottom: 1px solid #1f2342;
      background: #11163a
    }

    .theme-card .body {
      padding: 12px
    }

    .landing-preview {
      background: #0e1127;
      border: 1px solid #232741;
      border-radius: 12px;
      overflow: hidden
    }

    .landing-sim {
      display: grid;
      grid-template-rows: 260px auto;
      min-height: 360px;
      background: linear-gradient(140deg, var(--lp-bg1, #101635), var(--lp-bg2, #0b0f23));
      color: var(--lp-fg, #f3f6ff);
      font-family: var(--lp-font, var(--sans));
    }

    .landing-sim .media {
      position: relative;
      display: grid;
      place-items: center;
      overflow: hidden;
      background: #070a18
    }

    .landing-sim .media img,
    .landing-sim .media video {
      width: 100%;
      height: 100%;
      object-fit: cover
    }

    /* Make images/videos truly resizable inside the Theme Studio preview */
    .landing-sim .media .resizable {
      position: relative;
      display: inline-block;
      max-width: 100%;
    }

    .landing-sim .media .resizable img,
    .landing-sim .media .resizable video {
      width: 100% !important;
      height: auto !important;
      /* stop stretching to container height */
      object-fit: contain !important;
      /* respect the wrapper’s width */
      max-width: none !important;
      /* don't clamp by parent */
    }

    /* Improve drag handle behavior on touch */
    .resizer.se {
      touch-action: none;
      /* allow touch-drag without scrolling */
      cursor: se-resize;
      z-index: 10;
    }

    .landing-sim .content {
      padding: 16px
    }

    .landing-sim .cta {
      display: inline-block;
      margin-top: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      color: var(--lp-cta-fg, #09122a);
      background: var(--lp-cta-bg, #6c7dff);
      text-decoration: none;
      font-weight: 600;
    }

    /* List/table small helpers */
    .list {
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .item {
      border: 1px dashed #2a2e4d;
      border-radius: 12px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    /* Highlight the selected saved theme */
    /* Selected saved theme row = same visual language as nav .active */
    #themesList .item.selected {
      border: 1px solid var(--accent) !important;
      box-shadow:
        0 0 0 2px rgba(108, 125, 255, 0.25) inset,
        0 0 16px rgba(108, 125, 255, 0.35);
      background: linear-gradient(180deg, rgba(108, 125, 255, 0.08), transparent);
    }
  
    .table {
      width: 100%;
      border-collapse: collapse
    }

    .table th,
    .table td {
      border-bottom: 1px dashed #2a2e4d;
      padding: 8px;
      text-align: left
    }

    .table th {
      color: #aab1d6;
      font-weight: 600
    }

    .right {
      text-align: right
    }

    /* Modes UI */
    .modes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px
    }

    .mode-card {
      border: 1px solid #2a2e4d;
      background: #0b0f23;
      border-radius: 12px;
      padding: 10px;
      display: grid;
      gap: 8px
    }

    .mode-card .preview {
      height: 90px;
      border-radius: 8px;
      background: #070a18;
      overflow: hidden;
      display: grid;
      place-items: center;
      color: #8c93b2;
      font-size: 12px
    }

    .mode-card .t {
      font-weight: 700
    }

    /* Charts */
    .chart {
      width: 100%;
      height: 180px;
      display: block;
      background: #0b0f23;
      border: 1px solid #232741;
      border-radius: 12px
    }

    /* Responsive: sidebar becomes a top bar */
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr
      }

      aside#sidebar {
        position: static;
        height: auto
      }

      .qr-wrap {
        grid-template-columns: 1fr
      }

      #qrCanvas {
        width: 180px
      }
    }
  </style>
</head>

<body>
  <div class="logo">
    <img class="icon" src="https://www.themeqr.com/images/favicon-32x32.png" alt="ThemeQR" width="16" height="16" />
    <span>ThemeQR</span><span class="muted small"></span>
  </div>

  <main>
    <!-- LEFT NAV -->
    <aside id="sidebar">
      <div class="nav-group" id="navWork">
        <button class="nav-btn active" data-tab="qr">QR Studio</button>
        <button class="nav-btn" data-tab="themes">Theme Studio</button>
        <button class="nav-btn" data-tab="overlay">QR Overlay</button>
        <button class="nav-btn" data-tab="modes">Modes (Event/Social)</button>
        <button class="nav-btn" data-tab="analytics">Analytics</button>
        <button class="nav-btn" data-tab="io">Export / Import</button>
        <button class="nav-btn" data-tab="help">Help</button>
        <button class="btn nav-btn" id="btnQrDemo">QR Demo</button>
        <a class="nav-btn link" href="./themeqr-merch.html" target="_blank" rel="noopener">ThemeQR Merch
          <small>↗</small></a>
      </div>
    </aside>

    <!-- CONTENT -->
    <section id="content">
      <!-- ===== QR ===== -->
      <div id="qr" class="pad">
        <h2>QR Studio</h2>
        <p class="muted">
          Create a dynamic QR Code that resolves to
          <span class="code">landing.html</span> with your chosen Theme. You
          can change where it goes later — the printed QR still works.
        </p>

        <div class="qr-wrap" style="margin-top: 12px">
          <div class="qr-box">
            <div id="qrCanvas"></div>
          </div>
          <div>
            <div class="row">
              <div>
                <label>Link ID (letters, digits, “-”)</label>
                <input id="linkId" type="text" placeholder="e.g. spring-campaign" />
              </div>
              <div>
                <label>Destination URL</label>
                <input id="linkUrl" type="url" placeholder="https://example.com/landing" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Theme to apply on landing (optional)</label>
                <select id="linkTheme"></select>
              </div>
              <div>
                <label>QR Size (px)</label>
                <input id="qrSize" type="number" value="512" min="128" max="1024" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>QR Foreground</label><input id="qrFg" type="color" value="#000000" />
              </div>
              <div>
                <label>QR Background</label><input id="qrBg" type="color" value="#ffffff" />
              </div>
              <div>
                <label>Error Correction</label>
                <select id="qrEcc">
                  <option value="L">L (7%)</option>
                  <option value="M" selected>M (15%)</option>
                  <option value="Q">Q (25%)</option>
                  <option value="H">H (30%)</option>
                </select>
              </div>
            </div>

            <div class="stack" style="margin-top: 8px">
              <button class="btn primary" id="saveLink">
                Save / Update Link
              </button>
              <button class="btn" id="downloadQR">Download PNG</button>
              <span class="muted small">Encoded URL: <span id="encoded" class="code">—</span></span>
            </div>

            <div style="margin-top: 14px">
              <label>Saved Dynamic Links</label>
              <div id="linksList" class="list"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== THEME STUDIO ===== -->
      <div id="themes" class="pad" hidden>
        <h2>Theme Studio</h2>
        <p class="muted">
          Design a landing: image/video, colors, and a CTA. Save it as a theme
          and apply it to any QR.
        </p>

        <div class="row">
          <div>
            <label>Theme Name</label><input id="themeName" type="text" placeholder="e.g. Neon Night" />
          </div>
          <div>
            <label>Display Title</label><input id="themeTitle" type="text" placeholder="Your catchy headline" />
          </div>
          <div>
            <label>Subtitle</label><input id="themeSubtitle" type="text" placeholder="One line description" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>CTA Text</label><input id="themeCtaText" type="text" placeholder="Shop Now" />
          </div>
          <div>
            <label>CTA URL (optional)</label><input id="themeCtaUrl" type="url" placeholder="https://example.com" />
          </div>
          <div>
            <label>Font Family</label>
            <select id="themeFont">
              <option value="Inter,system-ui">Inter (Default)</option>
              <option value="Georgia,serif">Georgia (Serif)</option>
              <option value="Tahoma,sans-serif">Tahoma</option>
              <option value="'Segoe UI',sans-serif">Segoe UI</option>
              <option value="Verdana,sans-serif">Verdana</option>
              <option value="'Times New Roman',serif">Times</option>
              <option value="'Courier New',monospace">Courier</option>
            </select>
          </div>
        </div>

        <!-- Redirect + Skip -->
        <div class="row">
          <div>
            <label>Redirect Delay (seconds)</label>
            <input id="themeDelay" type="number" min="0" max="120" step="1" value="2" />
            <div class="small muted">0 = no auto-redirect</div>
          </div>
          <div style="display: flex; align-items: flex-end; gap: 8px">
            <label class="pill small" style="margin: 0">
              <input id="themeShowSkip" type="checkbox" checked style="vertical-align: middle; margin-right: 6px" />
              Show “Skip” button
            </label>
          </div>
          <div>
            <label>Skip Button Text</label>
            <input id="themeSkipText" type="text" value="Skip" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>BG Color 1</label><input id="themeBg1" type="color" value="#101635" />
          </div>
          <div>
            <label>BG Color 2</label><input id="themeBg2" type="color" value="#0b0f23" />
          </div>
          <div>
            <label>Text Color</label><input id="themeFg" type="color" value="#f3f6ff" />
          </div>
          <div>
            <label>CTA BG</label><input id="themeCtaBg" type="color" value="#6c7dff" />
          </div>
          <div>
            <label>CTA Text</label><input id="themeCtaFg" type="color" value="#09122a" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Upload Image or Video</label><input id="themeMedia" type="file" accept="image/*,video/*" />
          </div>
          <div>
            <label>Media Alt Text (for images)</label><input id="themeAlt" type="text"
              placeholder="Describe the image" />
          </div>
          <div style="display: flex; align-items: flex-end">
            <button id="clearMedia" class="btn ghost">Remove Media</button>
          </div>
        </div>

        <div class="row" style="margin-top: 8px">
          <div class="theme-card" style="flex: 1">
            <header><strong>Live Preview</strong></header>
            <div class="body">
              <div class="landing-preview">
                <div id="landingSim" class="landing-sim">
                  <div class="media" id="simMedia">
                    <div class="placard">Upload media to preview…</div>
                  </div>
                  <div class="content">
                    <div id="simTitle" style="font-size: 22px; font-weight: 800">
                      Your catchy headline
                    </div>
                    <div id="simSubtitle" class="muted" style="margin-top: 4px">
                      One line description
                    </div>
                    <a id="simCta" class="cta" href="#" target="_blank" rel="noopener">Shop Now</a>
                  </div>
                </div>
              </div>
              <div class="small muted" style="margin-top: 8px">
                This simulates <code>landing.html?themeId=…</code>
              </div>
            </div>
          </div>

          <div style="width: 360px">
            <label>Saved Themes</label>
            <div id="themesList" class="list"></div>
            <div class="stack" style="margin-top: 10px">
              <button class="btn primary" id="saveTheme">
                Save / Update Theme
              </button>
              <button class="btn warn" id="deleteTheme">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== OVERLAY ===== -->
      <div id="overlay" class="pad" hidden>
        <h2>QR Overlay Composer</h2>
        <p class="muted">
          Upload an image or video and place the QR over it. Export a PNG
          snapshot for print or social.
        </p>

        <div class="stage-wrap">
          <div id="overlayStage">
            <div class="placard">
              Drop image/video here or use the uploader below
            </div>
            <div id="canvasBg"></div>
            <div id="qrDraggable" class="floating-qr" hidden>
              <div id="qrDraggableInner"></div>
              <div class="resize-handle" title="Drag to resize"></div>
            </div>
          </div>

          <div class="stack" style="margin-top: 12px">
            <input id="overlayFile" type="file" accept="image/*,video/*" />
            <button class="btn" id="overlayClear">Clear</button>
            <span class="pill small">QR size: <span id="overlayQrPx">180</span>px</span>
            <label class="pill small">Opacity
              <input id="overlayOpacity" type="range" min="0.2" max="1" step="0.05" value="1"
                style="vertical-align: middle; margin-left: 8px" />
            </label>
            <button id="overlayExport" class="btn primary">Export PNG</button>
          </div>
        </div>
      </div>

      <!-- ===== MODES (Event / Social) ===== -->
      <div id="modes" class="pad" hidden>
        <h2>Modes</h2>

        <div class="theme-card">
          <header><strong>Pick a Link & Mode</strong></header>
          <div class="body">
            <div class="row">
              <div>
                <label>Active Link</label>
                <select id="modeLinkSelect"></select>
              </div>
              <div class="stack" style="align-items: flex-end">
                <label class="pill small" style="margin: 0"><input type="radio" name="uimode" value="event" checked />
                  Event Mode</label>
                <label class="pill small" style="margin: 0"><input type="radio" name="uimode" value="social" /> Social
                  Mode</label>
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top: 10px">
          <div class="theme-card" style="flex: 2">
            <header><strong id="modesHeader">Event Presets</strong></header>
            <div class="body">
              <div id="presetsGrid" class="modes-grid"></div>
            </div>
          </div>
          <div class="theme-card" style="width: 320px">
            <header><strong>Social Playlist</strong></header>
            <div class="body">
              <div class="small muted">
                Add themes to rotate when in Social Mode.
              </div>
              <div id="playlist" class="list" style="margin: 8px 0"></div>
              <div class="stack">
                <button class="btn" id="nextPreset">Next</button>
                <button class="btn ghost" id="shufflePreset">Random</button>
                <label class="pill small" title="Auto-apply next preset on a timer" style="margin-left: 6px">
                  <input id="autoRotate" type="checkbox" /> Auto-rotate
                </label>
                <input id="rotateSec" type="number" min="5" value="15" style="width: 80px" title="Seconds" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== ANALYTICS ===== -->
      <div id="analytics" class="pad" hidden>
        <h2>Analytics</h2>
        <p class="muted">
          Local-only analytics for your scans. Use “Record Test Scan” or
          “Generate Demo Data”.
        </p>

        <div class="row" style="margin-bottom: 10px">
          <div class="kpi" style="
                flex: 1;
                background: #0b0f23;
                border: 1px solid #232741;
                border-radius: 12px;
                padding: 12px;
              ">
            <div class="muted small">Total Scans</div>
            <div id="kpiTotal" style="font-size: 22px; font-weight: 800">
              0
            </div>
          </div>
          <div class="kpi" style="
                flex: 1;
                background: #0b0f23;
                border: 1px solid #232741;
                border-radius: 12px;
                padding: 12px;
              ">
            <div class="muted small">Unique Links</div>
            <div id="kpiUnique" style="font-size: 22px; font-weight: 800">
              0
            </div>
          </div>
          <div class="kpi" style="
                flex: 1;
                background: #0b0f23;
                border: 1px solid #232741;
                border-radius: 12px;
                padding: 12px;
              ">
            <div class="muted small">Last Scan</div>
            <div id="kpiLast" style="font-size: 22px; font-weight: 800">
              —
            </div>
          </div>
          <div class="kpi" style="
                flex: 1;
                background: #0b0f23;
                border: 1px solid #232741;
                border-radius: 12px;
                padding: 12px;
              ">
            <div class="muted small">Avg / Day</div>
            <div id="kpiAvg" style="font-size: 22px; font-weight: 800">0</div>
          </div>
        </div>

        <div class="row" style="margin-bottom: 10px">
          <div class="theme-card" style="flex: 1">
            <header><strong>Scans Over Time (daily)</strong></header>
            <div class="body">
              <canvas id="chartTime" class="chart" height="180"></canvas>
            </div>
          </div>
          <div class="theme-card" style="flex: 1">
            <header><strong>Top Links</strong></header>
            <div class="body">
              <canvas id="chartTop" class="chart" height="180"></canvas>
            </div>
          </div>
        </div>

        <div class="theme-card" style="margin-bottom: 10px">
          <header><strong>Filters</strong></header>
          <div class="body">
            <div class="row">
              <div><label>From</label><input id="fFrom" type="date" /></div>
              <div><label>To</label><input id="fTo" type="date" /></div>
              <div>
                <label>Link Filter</label>
                <select id="fLink">
                  <option value="">All links</option>
                </select>
              </div>
              <div style="display: flex; align-items: flex-end; gap: 8px">
                <button class="btn" id="applyFilters">Apply</button>
                <button class="btn ghost" id="resetFilters">Reset</button>
              </div>
            </div>
          </div>
        </div>

        <div class="theme-card" style="margin-bottom: 10px">
          <header><strong>Per-link Summary</strong></header>
          <div class="body" style="overflow: auto">
            <table class="table" id="tblLinks">
              <thead>
                <tr>
                  <th>Link ID</th>
                  <th class="right">Scans</th>
                  <th>Last</th>
                  <th class="right">Share</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="theme-card">
          <header><strong>Actions</strong></header>
          <div class="body">
            <div class="stack">
              <select id="scanLinkSelect"></select>
              <button class="btn" id="recordScan">Record Test Scan</button>
              <button class="btn ghost" id="genDemo">
                Generate Demo Data
              </button>
              <button class="btn" id="exportScans">Export Scans JSON</button>
              <input id="importScansFile" type="file" accept="application/json" />
              <button class="btn primary" id="importScans">
                Import Scans
              </button>
              <button class="btn warn" id="clearScans">Clear Scans</button>
            </div>
            <div class="small muted" style="margin-top: 6px">
              Scans are stored in <code>localStorage</code> under
              <span class="code">qrstudio.scans</span>.
            </div>
          </div>
        </div>
      </div>

      <!-- ===== EXPORT / IMPORT ===== -->
      <div id="io" class="pad" hidden>
        <h2>Export / Import</h2>
        <p class="muted">
          Export JSON for backup or to migrate. Import will merge by ID
          (overwriting duplicates).
        </p>
        <div class="row">
          <div class="theme-card" style="flex: 1">
            <header><strong>Export</strong></header>
            <div class="body">
              <div class="stack">
                <button class="btn" id="exportThemes">
                  Export Themes JSON
                </button>
                <button class="btn" id="exportLinks">
                  Export Dynamic Links JSON
                </button>
              </div>
            </div>
          </div>
          <div class="theme-card" style="flex: 1">
            <header><strong>Import</strong></header>
            <div class="body">
              <input id="importFile" type="file" accept="application/json" />
              <div class="small muted" style="margin-top: 6px">
                Tip: you can also paste JSON into the box below and click
                “Import from Text”.
              </div>
              <label>Paste JSON</label>
              <textarea id="importText" placeholder='{"themes":[],"links":[]}'>
{"themes":[],"links":[]}</textarea>
              <div class="stack">
                <button class="btn primary" id="importNow">
                  Import from File
                </button>
                <button class="btn" id="importFromText">
                  Import from Text
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="small muted" style="padding: 14px; text-align: center">
          © 2025 All rights reserved. | Powered by ThemeQR
        </div>
      </div>

      <!-- ===== HELP ===== -->
      <div id="help" class="pad" hidden>
        <h2>Help</h2>
        <p class="muted">
          Quick start: 1) Create a Theme in Theme Studio. 2) Create a Dynamic
          Link in QR Studio and (optionally) attach your Theme. 3) Print or
          share the QR. 4) You can update the destination or Theme later — the
          QR still works.
        </p>
        <div class="stack" style="margin-top: 10px">
          <button class="btn" data-goto="themes">Go to Theme Studio</button>
          <button class="btn" data-goto="overlay">Go to QR Overlay</button>
          <a class="btn ghost" href="./landing.html" target="_blank" rel="noopener">Open QR Demo ↗</a>
        </div>
        <div class="small muted" style="margin-top: 12px">
          The encoded URL looks like
          <span class="code">landing.html?linkId={id}&themeId={theme}</span>.
          Host these files on any static host and it works.
        </div>
      </div>
    </section>
  </main>

  <!-- QRCode library (CDN) -->
  <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>

  <script>
    /* ---------- Utilities ---------- */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function normalizeHttpUrl(input) {
      if (!input) return "";
      const u = String(input).trim();
      if (u.startsWith("//")) return "https:" + u;
      if (/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(u)) return u;
      return "https://" + u.replace(/^\/+/, "");
    }

    document.getElementById("btnQrDemo").addEventListener("click", (e) => {
      e.preventDefault();
      openQrDemoWithSelection();
    });

    function getSelectedThemeId() {
      const selRow = document.querySelector("#themesList .item.selected");
      if (selRow?.dataset.id) return selRow.dataset.id;

      const dd = document.getElementById("linkTheme");
      if (dd?.value) return dd.value;

      if (workingTheme?.id) return workingTheme.id;

      return "";
    }

    function openQrDemoWithSelection() {
      const linkId = (document.getElementById("linkId")?.value || "").trim();
      const themeId = getSelectedThemeId();
      const url = new URL("landing.html", location.href);
      if (linkId) url.searchParams.set("linkId", linkId);
      if (themeId) url.searchParams.set("themeId", themeId);
      window.open(url.toString(), "_blank", "noopener");
    }

    const store = {
      get(key, fallback) {
        try {
          return JSON.parse(localStorage.getItem(key)) ?? fallback;
        } catch {
          return fallback;
        }
      },
      set(key, val) {
        try {
          localStorage.setItem(key, JSON.stringify(val));
        } catch (e) {
          if (e?.name === "QuotaExceededError")
            alert("Storage full. Remove large media.");
          else console.error(e);
        }
      },
    };
    const db = {
      themes: () => store.get("qrstudio.themes", []),
      links: () => store.get("qrstudio.links", []),
      scans: () => store.get("qrstudio.scans", []),
      saveThemes(arr) {
        store.set("qrstudio.themes", arr);
      },
      saveLinks(arr) {
        store.set("qrstudio.links", arr);
      },
      saveScans(arr) {
        store.set("qrstudio.scans", arr);
      },
    };
    const uid = (p = "t") =>
      `${p}_${Math.random().toString(36).slice(2, 8)}${Date.now()
        .toString(36)
        .slice(-4)}`;

    /* ---------- Navigation (left sidebar) ---------- */
    const pages = {
      qr: $("#qr"),
      themes: $("#themes"),
      overlay: $("#overlay"),
      modes: $("#modes"),
      analytics: $("#analytics"),
      io: $("#io"),
      help: $("#help"),
    };

    // Handle nav clicks
    $("#sidebar").addEventListener("click", (e) => {
      const btn = e.target.closest(".nav-btn");
      if (!btn || !btn.dataset.tab) return;

      $$("#sidebar .nav-btn").forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");

      const tab = btn.dataset.tab;
      Object.entries(pages).forEach(([k, v]) => (v.hidden = k !== tab));

      if (tab === "analytics") renderAnalytics();
      if (tab === "modes") {
        seedPresetsIfEmpty();
        refreshModeLinkSelect();
        const m = getMode();
        $$('input[name="uimode"]').forEach(
          (r) => (r.checked = r.value === m)
        );
        renderPresetsGrid();
        renderPlaylist();
      }
    });

    // Help buttons -> navigate
    $("#help").addEventListener("click", (e) => {
      const go = e.target?.dataset?.goto;
      if (!go) return;
      // activate left nav button with matching data-tab
      const targetBtn = $(`#sidebar .nav-btn[data-tab="${go}"]`);
      if (targetBtn) targetBtn.click();
    });

    /* ---------- QR rendering helper ---------- */
    function hasQRCodeLib() {
      return typeof window.QRCode !== "undefined";
    }
    function hexNoHash(c) {
      return String(c || "#000000").replace("#", "");
    }

    async function renderQRInto(
      host,
      text,
      { size = 512, bg = "#ffffff", fg = "#000000", ecc = "M" } = {}
    ) {
      host.innerHTML = "";
      if (hasQRCodeLib()) {
        const c = document.createElement("canvas");
        c.width = c.height = size;
        QRCode.toCanvas(c, String(text || ""), {
          errorCorrectionLevel:
            { L: "low", M: "medium", Q: "quartile", H: "high" }[ecc] ||
            "medium",
          color: { dark: fg, light: bg },
          width: size,
          margin: 0,
        });
        host.appendChild(c);
        return { type: "canvas", el: c };
      }
      // Fallback: image API
      const img = new Image();
      img.alt = "QR";
      img.width = size;
      img.height = size;
      img.crossOrigin = "anonymous";
      img.src = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&ecc=${encodeURIComponent(
        ecc
      )}&color=${hexNoHash(fg)}&bgcolor=${hexNoHash(
        bg
      )}&qzone=0&data=${encodeURIComponent(String(text || ""))}`;
      host.appendChild(img);
      if (typeof img.decode === "function") {
        try {
          await img.decode();
        } catch { }
      }
      return { type: "img", el: img };
    }

    function currentLandingUrl(linkId, themeId) {
      const url = new URL("landing.html", location.href);
      const p = url.searchParams;
      p.set("linkId", linkId);
      if (themeId) p.set("themeId", themeId);
      return url.toString();
    }

    /* ---------- QR Studio ---------- */
    const qrCanvasHost = $("#qrCanvas");

    async function drawQR() {
      const size = +$("#qrSize").value || 512;
      const fg = $("#qrFg").value,
        bg = $("#qrBg").value,
        ecc = $("#qrEcc").value;
      const linkId = ($("#linkId").value || "").trim();
      const themeId = $("#linkTheme").value || "";
      const payloadUrl = linkId
        ? currentLandingUrl(linkId, themeId)
        : "https://example.com";
      const result = await renderQRInto(qrCanvasHost, payloadUrl, {
        size,
        bg,
        fg,
        ecc,
      });
      $("#encoded").textContent = payloadUrl;
      qrCanvasHost.dataset.qrType = result.type;
    }
    $("#qrSize, #qrFg, #qrBg, #qrEcc, #linkId, #linkTheme").addEventListener(
      "input",
      drawQR
    );

    function renderLinksList() {
      const list = $("#linksList");
      list.innerHTML = "";
      for (const link of db.links()) {
        const div = document.createElement("div");
        div.className = "item small";
        const theme = db.themes().find((t) => t.id === link.themeId);
        const target = document.createElement("div");
        target.innerHTML = `<div><b>${link.id}</b> → <span class="muted">${link.url || "(no destination set)"
          }</span></div>
                    <div class="muted">Theme: ${theme ? theme.name : "—"
          } · Last updated: ${new Date(link.updated).toLocaleString()}</div>`;
        const actions = document.createElement("div");
        actions.className = "stack";
        const openBtn = document.createElement("a");
        openBtn.className = "btn";
        openBtn.textContent = "Open";
        openBtn.href = currentLandingUrl(link.id, link.themeId);
        openBtn.target = "_blank";
        const editBtn = document.createElement("button");
        editBtn.className = "btn";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => {
          $("#linkId").value = link.id;
          $("#linkUrl").value = link.url;
          $("#linkTheme").value = link.themeId || "";
          drawQR();
        };
        const delBtn = document.createElement("button");
        delBtn.className = "btn warn";
        delBtn.textContent = "Delete";
        delBtn.onclick = () => {
          const rest = db.links().filter((l) => l.id !== link.id);
          db.saveLinks(rest);
          renderLinksList();
          refreshAnalyticsSelectors();
        };
        actions.append(openBtn, editBtn, delBtn);
        div.append(target, actions);
        list.appendChild(div);
      }
      refreshAnalyticsSelectors();
    }

    $("#saveLink").addEventListener("click", () => {
      const id = ($("#linkId").value || "").trim();
      const urlRaw = ($("#linkUrl").value || "").trim();
      const url = normalizeHttpUrl(urlRaw);
      $("#linkUrl").value = url;

      const themeId = $("#linkTheme").value || "";
      if (!id) {
        alert("Please provide a Link ID");
        return;
      }
      const links = db.links();
      const idx = links.findIndex((l) => l.id === id);
      const rec = { id, url, themeId, updated: Date.now() };
      if (idx >= 0) links[idx] = rec;
      else links.unshift(rec);
      db.saveLinks(links);
      renderLinksList();
      drawQR();
    });

    $("#downloadQR").addEventListener("click", () => {
      let node = qrCanvasHost.querySelector("canvas, img");
      if (!node) {
        alert("Generate a QR first.");
        return;
      }
      const canvas =
        node.tagName === "CANVAS"
          ? node
          : (function imgToCanvas(img) {
            const c = document.createElement("canvas");
            c.width = img.naturalWidth || img.width || 512;
            c.height = img.naturalHeight || img.height || 512;
            c.getContext("2d").drawImage(img, 0, 0, c.width, c.height);
            return c;
          })(node);
      const dl = document.createElement("a");
      dl.download = `qr-${$("#linkId").value || "link"}.png`;
      dl.href = canvas.toDataURL("image/png");
      dl.click();
    });

    function refreshThemeDropdown() {
      const sel = $("#linkTheme");
      sel.innerHTML = `<option value="">— None —</option>`;
      for (const t of db.themes()) {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
      }
    }

    /* ---------- Theme Studio ---------- */
    let workingTheme = {
      id: "",
      name: "",
      title: "",
      subtitle: "",
      font: "Inter,system-ui",
      colors: {
        bg1: "#101635",
        bg2: "#0b0f23",
        fg: "#f3f6ff",
        ctaBg: "#6c7dff",
        ctaFg: "#09122a",
      },
      cta: { text: "Shop Now", url: "" },
      media: { kind: "", data: "", alt: "" },
      settings: {
        redirectDelay: 2,
        showSkip: true,
        skipText: "Skip",
        mediaBox: { w: 320 },
      },
    };

    function applySim() {
      const s = workingTheme;
      const root = $("#landingSim").style;
      root.setProperty("--lp-bg1", s.colors.bg1);
      root.setProperty("--lp-bg2", s.colors.bg2);
      root.setProperty("--lp-fg", s.colors.fg);
      root.setProperty("--lp-cta-bg", s.colors.ctaBg);
      root.setProperty("--lp-cta-fg", s.colors.ctaFg);
      root.setProperty("--lp-font", s.font);

      $("#simTitle").textContent = s.title || "Your catchy headline";
      $("#simSubtitle").textContent = s.subtitle || "One line description";
      const cta = $("#simCta");
      cta.textContent = s.cta.text || "Shop Now";
      cta.href = normalizeHttpUrl(s.cta.url || "") || "#";

      // Redirect note + Skip button preview
      const contentEl = document.querySelector("#landingSim .content");
      let note = document.getElementById("simNote");
      if (!note) {
        note = document.createElement("div");
        note.id = "simNote";
        note.className = "muted small";
        note.style.marginTop = "6px";
        contentEl.appendChild(note);
      }
      const delay = Number(s.settings?.redirectDelay ?? 2);
      note.textContent =
        delay > 0 ? `Auto-redirect in ${delay}s…` : "No auto-redirect";

      let skip = document.getElementById("simSkip");
      if (!skip) {
        skip = document.createElement("a");
        skip.id = "simSkip";
        skip.className = "cta";
        skip.style.marginLeft = "8px";
        skip.href = "#";
        contentEl.appendChild(skip);
      }
      skip.textContent = s.settings?.skipText || "Skip";
      skip.style.display =
        s.settings?.showSkip ?? true ? "inline-block" : "none";

      // media
      const mwrap = $("#simMedia");
      mwrap.innerHTML = "";

      const createWrapper = () => {
        const wrap = document.createElement("div");
        wrap.className = "resizable";
        wrap.id = "simMediaBox";
        const parentW = mwrap.clientWidth || 360;
        const savedW = Number(workingTheme.settings?.mediaBox?.w);
        const initial = Number.isFinite(savedW) ? savedW : Math.round(parentW * 0.9);
        const clamped = Math.max(120, Math.min(parentW - 12, initial));
        wrap.style.width = clamped + "px";
        wrap.style.maxWidth = "100%";
        wrap.style.display = "inline-block"; // important for width to take effect
        return wrap;
      };

      // IMAGE
      if (s.media.kind === "image" && s.media.data) {
        const wrap = createWrapper();
        const img = document.createElement("img");
        img.src = s.media.data;
        img.alt = s.media.alt || "";
        wrap.appendChild(img);
        mwrap.appendChild(wrap);

        makeResizable(wrap, {
          onChange: (w) => {
            workingTheme.settings = workingTheme.settings || {};
            workingTheme.settings.mediaBox = {
              ...(workingTheme.settings.mediaBox || {}),
              w: Math.round(w),
            };
          },
        });
        ensureMediaControls(mwrap);
      }
      // VIDEO
      else if (s.media.kind === "video" && s.media.data) {
        const wrap = createWrapper();
        const vid = document.createElement("video");
        vid.src = s.media.data;
        vid.muted = true; vid.loop = true; vid.playsInline = true; vid.controls = false;
        wrap.appendChild(vid);
        mwrap.appendChild(wrap);

        makeResizable(wrap, {
          onChange: (w) => {
            workingTheme.settings = workingTheme.settings || {};
            workingTheme.settings.mediaBox = {
              ...(workingTheme.settings.mediaBox || {}),
              w: Math.round(w),
            };
          },
        });
        ensureMediaControls(mwrap);
      }


      $("#themeName").addEventListener(
        "input",
        (e) => (workingTheme.name = e.target.value)
      );
      $("#themeTitle").addEventListener("input", (e) => {
        workingTheme.title = e.target.value;
        applySim();
      });
      $("#themeSubtitle").addEventListener("input", (e) => {
        workingTheme.subtitle = e.target.value;
        applySim();
      });
      $("#themeCtaText").addEventListener("input", (e) => {
        workingTheme.cta.text = e.target.value;
        applySim();
      });
      $("#themeCtaUrl").addEventListener("input", (e) => {
        workingTheme.cta.url = e.target.value;
        applySim();
      });
      $("#themeFont").addEventListener("change", (e) => {
        workingTheme.font = e.target.value;
        applySim();
      });
      $("#themeBg1").addEventListener("input", (e) => {
        workingTheme.colors.bg1 = e.target.value;
        applySim();
      });
      $("#themeBg2").addEventListener("input", (e) => {
        workingTheme.colors.bg2 = e.target.value;
        applySim();
      });
      $("#themeFg").addEventListener("input", (e) => {
        workingTheme.colors.fg = e.target.value;
        applySim();
      });
      $("#themeCtaBg").addEventListener("input", (e) => {
        workingTheme.colors.ctaBg = e.target.value;
        applySim();
      });
      $("#themeCtaFg").addEventListener("input", (e) => {
        workingTheme.colors.ctaFg = e.target.value;
        applySim();
      });
      $("#themeAlt").addEventListener("input", (e) => {
        workingTheme.media.alt = e.target.value;
      });
      $("#themeDelay").addEventListener("input", (e) => {
        const v = Math.max(0, Math.min(120, Number(e.target.value || 0)));
        (workingTheme.settings ||= {}).redirectDelay = v;
        applySim();
      });
      $("#themeShowSkip").addEventListener("change", (e) => {
        (workingTheme.settings ||= {}).showSkip = !!e.target.checked;
        applySim();
      });
      $("#themeSkipText").addEventListener("input", (e) => {
        (workingTheme.settings ||= {}).skipText = e.target.value || "Skip";
        applySim();
      });

      function captureFileAsDataURL(file) {
        return new Promise((res, rej) => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.onerror = rej;
          r.readAsDataURL(file);
        });
      }
      async function compressImage(file, { maxW = 1280, quality = 0.8 } = {}) {
        const img = new Image();
        const url = URL.createObjectURL(file);
        await new Promise((res, rej) => {
          img.onload = res;
          img.onerror = rej;
          img.src = url;
        });
        const scale = Math.min(1, maxW / img.width);
        const w = Math.round(img.width * scale),
          h = Math.round(img.height * scale);
        const c = document.createElement("canvas");
        c.width = w;
        c.height = h;
        c.getContext("2d").drawImage(img, 0, 0, w, h);
        const out = c.toDataURL("image/jpeg", quality);
        URL.revokeObjectURL(url);
        return out;
      }
      $("#themeMedia").addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const isVid = f.type.startsWith("video/");
        const data = isVid
          ? await captureFileAsDataURL(f)
          : await compressImage(f, { maxW: 1280, quality: 0.8 });
        workingTheme.media = {
          kind: isVid ? "video" : "image",
          data,
          alt: $("#themeAlt").value || "",
        };
        applySim();
      });
      $("#clearMedia").addEventListener("click", () => {
        workingTheme.media = { kind: "", data: "", alt: "" };
        $("#themeMedia").value = "";
        $("#themeAlt").value = "";
        applySim();
      });

      function renderThemesList(selectedId = "") {
        const list = $("#themesList");
        list.innerHTML = "";

        const currentId = selectedId || workingTheme?.id || "";

        for (const t of db.themes()) {
          const row = document.createElement("div");
          row.className = "item";
          row.dataset.id = t.id; // ← track which theme this row is

          if (t.id === currentId) {
            row.classList.add("selected"); // ← glow the selected row
          }

          const left = document.createElement("div");
          left.innerHTML = `
                  <div><b>${t.name}</b></div>
                  <div class="muted small">${t.title || "—"}</div>
                `;

          const actions = document.createElement("div");
          actions.className = "stack";

          const useBtn = document.createElement("button");
          useBtn.className = "btn";
          useBtn.textContent = "Load";
          useBtn.onclick = () => {
            // load into workingTheme + inputs
            workingTheme = JSON.parse(JSON.stringify(t));
            $("#themeName").value = t.name || "";
            $("#themeTitle").value = t.title || "";
            $("#themeSubtitle").value = t.subtitle || "";
            $("#themeCtaText").value = t.cta?.text || "";
            $("#themeCtaUrl").value = t.cta?.url || "";
            $("#themeFont").value = t.font || "Inter,system-ui";
            $("#themeBg1").value = t.colors?.bg1 || "#101635";
            $("#themeBg2").value = t.colors?.bg2 || "#0b0f23";
            $("#themeFg").value = t.colors?.fg || "#f3f6ff";
            $("#themeCtaBg").value = t.colors?.ctaBg || "#6c7dff";
            $("#themeCtaFg").value = t.colors?.ctaFg || "#09122a";
            $("#themeAlt").value = t.media?.alt || "";
            $("#themeDelay").value = t.settings?.redirectDelay ?? 2;
            $("#themeShowSkip").checked = t.settings?.showSkip ?? true;
            $("#themeSkipText").value = t.settings?.skipText ?? "Skip";

            applySim();

            // re-render list so the selected row glows
            renderThemesList(t.id);
          };

          const copyId = document.createElement("button");
          copyId.className = "btn ghost";
          copyId.textContent = "Copy ID";
          copyId.onclick = () => {
            navigator.clipboard.writeText(t.id || "");
            copyId.textContent = "Copied!";
            setTimeout(() => (copyId.textContent = "Copy ID"), 1000);
          };

          actions.append(useBtn, copyId);
          row.append(left, actions);
          list.appendChild(row);
        }

        // Keep the QR section dropdown synced
        refreshThemeDropdown();
        if (currentId) $("#linkTheme").value = currentId;
      }

      $("#saveTheme").addEventListener("click", () => {
        if (!workingTheme.name.trim()) {
          alert("Please give your theme a name.");
          return;
        }
        if (!workingTheme.id) workingTheme.id = uid("theme");
        const themes = db.themes();
        const idx = themes.findIndex((t) => t.id === workingTheme.id);
        const copy = JSON.parse(JSON.stringify(workingTheme));
        if (idx >= 0) themes[idx] = copy;
        else themes.unshift(copy);
        db.saveThemes(themes);
        renderThemesList(copy.id);
      });

      $("#deleteTheme").addEventListener("click", () => {
        if (!workingTheme.id) {
          alert("Load a theme first.");
          return;
        }
        if (!confirm("Delete this theme?")) return;
        db.saveThemes(db.themes().filter((t) => t.id !== workingTheme.id));
        workingTheme = {
          id: "",
          name: "",
          title: "",
          subtitle: "",
          font: "Inter,system-ui",
          colors: {
            bg1: "#101635",
            bg2: "#0b0f23",
            fg: "#f3f6ff",
            ctaBg: "#6c7dff",
            ctaFg: "#09122a",
          },
          cta: { text: "Shop Now", url: "" },
          media: { kind: "", data: "", alt: "" },
          settings: {
            redirectDelay: 2,
            showSkip: true,
            skipText: "Skip",
            mediaBox: { w: 320 },
          },
        };
        $("#themeName").value =
          $("#themeTitle").value =
          $("#themeSubtitle").value =
          $("#themeCtaText").value =
          $("#themeCtaUrl").value =
          $("#themeAlt").value =
          "";
        $("#themeMedia").value = "";
        renderThemesList();
        applySim();
      });

      /* ---------- Overlay Composer (drag/resize fixed) ---------- */
      const overlayStage = $("#overlayStage");
      const qrDrag = $("#qrDraggable");
      const qrDragInner = $("#qrDraggableInner");
      const qrHandle = qrDrag.querySelector(".resize-handle");
      let overlayMediaEl = null;
      let dragState = null;

      function ensureDraggableQR() {
        const linkId = $("#linkId").value || "example";
        const themeId = $("#linkTheme").value || "";
        const fg = $("#qrFg").value,
          bg = $("#qrBg").value,
          ecc = $("#qrEcc").value;
        const url = currentLandingUrl(linkId, themeId);
        const size = Math.max(
          128,
          Math.min(1024, Math.round(qrDrag.clientWidth || 180))
        );
        qrDragInner.innerHTML = "";
        renderQRInto(qrDragInner, url, { size, bg, fg, ecc }).then(() => {
          $("#overlayQrPx").textContent = size;
        });
      }
      function setOverlayOpacity(val) {
        qrDrag.style.opacity = val;
      }

      function loadOverlayFile(file) {
        const wrap = $("#canvasBg");
        wrap.innerHTML = "";
        if (!file) {
          overlayMediaEl = null;
          qrDrag.hidden = true;
          return;
        }
        overlayStage.querySelector(".placard")?.remove();

        const isVideo = file.type.startsWith("video/");
        let el = isVideo
          ? document.createElement("video")
          : document.createElement("img");
        if (isVideo) {
          el.controls = true;
          el.muted = true;
          el.autoplay = true;
          el.loop = true;
          el.playsInline = true;
          el.preload = "metadata";
          el.addEventListener(
            "loadedmetadata",
            () => {
              el.play().catch(() => { });
            },
            { once: true }
          );
        }
        el.style.width = "100%";
        el.style.height = "100%";
        el.style.objectFit = "cover";
        el.style.display = "block";
        wrap.appendChild(el);
        const blobUrl = URL.createObjectURL(file);
        el.src = blobUrl;
        overlayMediaEl = el;
        qrDrag.hidden = false;
        ensureDraggableQR();
        el.addEventListener("ended", () => URL.revokeObjectURL(blobUrl), {
          once: true,
        });
      }

      $("#overlayFile").addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        if (f) loadOverlayFile(f);
      });
      overlayStage.addEventListener("dragover", (e) => {
        e.preventDefault();
        overlayStage.style.outline = "2px dashed #6c7dff";
      });
      overlayStage.addEventListener(
        "dragleave",
        () => (overlayStage.style.outline = "none")
      );
      overlayStage.addEventListener("drop", (e) => {
        e.preventDefault();
        overlayStage.style.outline = "none";
        const f = e.dataTransfer.files?.[0];
        if (f) loadOverlayFile(f);
      });

      // Drag to move (no HTML5 drag events to avoid clobbering background)
      qrDrag.addEventListener("mousedown", (e) => {
        if (e.target === qrHandle) return;
        dragState = {
          type: "move",
          startX: e.clientX,
          startY: e.clientY,
          origLeft: qrDrag.offsetLeft,
          origTop: qrDrag.offsetTop,
        };
        document.body.style.userSelect = "none";
      });
      // Resize
      qrHandle.addEventListener("mousedown", (e) => {
        e.stopPropagation();
        dragState = {
          type: "resize",
          startX: e.clientX,
          startY: e.clientY,
          origW: qrDrag.clientWidth,
        };
        qrDrag.classList.add("resizing");
        document.body.style.userSelect = "none";
      });
      window.addEventListener("mousemove", (e) => {
        if (!dragState) return;
        if (dragState.type === "move") {
          const dx = e.clientX - dragState.startX,
            dy = e.clientY - dragState.startY;
          qrDrag.style.left =
            Math.max(
              0,
              Math.min(
                overlayStage.clientWidth - qrDrag.clientWidth,
                dragState.origLeft + dx
              )
            ) + "px";
          qrDrag.style.top =
            Math.max(
              0,
              Math.min(
                overlayStage.clientHeight - qrDrag.clientHeight,
                dragState.origTop + dy
              )
            ) + "px";
        } else {
          const d = Math.max(
            120,
            dragState.origW + (e.clientX - dragState.startX)
          );
          qrDrag.style.width = qrDrag.style.height = d + "px";
          ensureDraggableQR();
        }
      });
      window.addEventListener("mouseup", () => {
        if (dragState?.type === "resize") qrDrag.classList.remove("resizing");
        dragState = null;
        document.body.style.userSelect = "";
      });

      $("#overlayOpacity").addEventListener("input", (e) =>
        setOverlayOpacity(e.target.value)
      );
      $("#overlayClear").addEventListener("click", () => {
        $("#canvasBg").innerHTML = "";
        overlayStage.insertAdjacentHTML(
          "afterbegin",
          '<div class="placard">Drop image/video here or use the uploader below</div>'
        );
        overlayMediaEl = null;
        qrDrag.hidden = true;
        $("#overlayFile").value = "";
      });
      $("#overlayExport").addEventListener("click", () => {
        const canvas = document.createElement("canvas");
        const rect = overlayStage.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        const ctx = canvas.getContext("2d");
        // draw media
        if (overlayMediaEl) {
          if (overlayMediaEl.tagName === "VIDEO") {
            const v = overlayMediaEl;
            if (!v.videoWidth || !v.videoHeight || v.readyState < 2) {
              alert("Video is not ready yet.");
              return;
            }
            const w = v.videoWidth,
              h = v.videoHeight;
            const scale = Math.max(canvas.width / w, canvas.height / h);
            const dw = w * scale,
              dh = h * scale,
              dx = (canvas.width - dw) / 2,
              dy = (canvas.height - dh) / 2;
            ctx.drawImage(v, dx, dy, dw, dh);
          } else {
            const img = overlayMediaEl;
            const w = img.naturalWidth,
              h = img.naturalHeight;
            if (!w || !h) {
              alert("Image not ready yet.");
              return;
            }
            const scale = Math.max(canvas.width / w, canvas.height / h);
            const dw = w * scale,
              dh = h * scale,
              dx = (canvas.width - dw) / 2,
              dy = (canvas.height - dh) / 2;
            ctx.drawImage(img, dx, dy, dw, dh);
          }
        } else {
          ctx.fillStyle = "#0b0f23";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        // draw QR
        let qrc = qrDragInner.querySelector("canvas, img");
        if (qrc && qrc.tagName !== "CANVAS") {
          const c = document.createElement("canvas");
          c.width = qrc.naturalWidth || qrc.width;
          c.height = qrc.naturalHeight || qrc.height;
          c.getContext("2d").drawImage(qrc, 0, 0, c.width, c.height);
          qrc = c;
        }
        ctx.globalAlpha = parseFloat($("#overlayOpacity").value || "1");
        const x = qrDrag.offsetLeft,
          y = qrDrag.offsetTop,
          s = qrDrag.clientWidth;
        ctx.drawImage(qrc, x, y, s, s);
        ctx.globalAlpha = 1;
        const dl = document.createElement("a");
        dl.download = "overlay-snapshot.png";
        dl.href = canvas.toDataURL("image/png");
        dl.click();
      });

      /* ---------- Analytics (lightweight) ---------- */
      function detectDevice(ua) {
        if (!ua) return "Other";
        if (/Android/i.test(ua)) return "Android";
        if (/iPhone|iPad|iPod/i.test(ua)) return "iOS";
        if (/Windows/i.test(ua)) return "Windows";
        if (/Macintosh|Mac OS X/i.test(ua)) return "macOS";
        return "Other";
      }
      function logScan({ linkId, source = "studio" }) {
        if (!linkId) return;
        const ua = navigator.userAgent || "";
        const scan = {
          id: uid("scan"),
          linkId,
          ts: Date.now(),
          ua,
          referrer: document.referrer || "",
          source,
          device: detectDevice(ua),
        };
        const arr = db.scans();
        arr.push(scan);
        db.saveScans(arr);
      }
      const ymd = (ts) => new Date(ts).toISOString().slice(0, 10);
      const fmtDateTime = (ts) => {
        const d = new Date(ts);
        return isNaN(d) ? "—" : d.toLocaleString();
      };
      function rangeDays(fromISO, toISO) {
        const out = [];
        const from = new Date(fromISO + "T00:00:00Z");
        const to = new Date(toISO + "T00:00:00Z");
        for (let d = new Date(from); d <= to; d.setUTCDate(d.getUTCDate() + 1))
          out.push(d.toISOString().slice(0, 10));
        return out;
      }
      function drawBars(
        canvas,
        labels,
        values,
        { color = "#6c7dff", max = null } = {}
      ) {
        const ctx = canvas.getContext("2d");
        const W = canvas.clientWidth || 600,
          H = canvas.height || 180;
        canvas.width = W;
        canvas.height = H;
        ctx.clearRect(0, 0, W, H);
        const pad = 24,
          gap = 8,
          n = values.length || 1;
        const barW = Math.max(
          6,
          Math.min(60, (W - pad * 2 - gap * (n - 1)) / n)
        );
        const vmax = Math.max(1, max ?? Math.max(...values, 1));
        ctx.strokeStyle = "#232741";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(pad, H - pad);
        ctx.lineTo(W - pad, H - pad);
        ctx.stroke();
        ctx.fillStyle = color;
        for (let i = 0; i < n; i++) {
          const x = pad + i * (barW + gap);
          const h = Math.round(((values[i] || 0) / vmax) * (H - pad * 2));
          const y = H - pad - h;
          ctx.fillRect(x, y, barW, Math.max(1, h));
        }
        ctx.fillStyle = "#aab1d6";
        ctx.font = "11px Inter, system-ui";
        const step = Math.ceil(n / 8);
        for (let i = 0; i < n; i += step) {
          const x = pad + i * (barW + gap) + barW / 2;
          const lab = labels[i] ?? "";
          ctx.save();
          ctx.translate(x, H - pad + 12);
          ctx.rotate(-Math.PI / 4);
          ctx.fillText(lab, 0, 0);
          ctx.restore();
        }
      }
      function refreshAnalyticsSelectors() {
        const links = db.links();
        const fSel = $("#fLink"),
          sSel = $("#scanLinkSelect");
        if (fSel) {
          const cur = fSel.value;
          fSel.innerHTML =
            `<option value="">All links</option>` +
            links
              .map((l) => `<option value="${l.id}">${l.id}</option>`)
              .join("");
          fSel.value = cur;
        }
        if (sSel) {
          sSel.innerHTML = links.length
            ? links
              .map((l) => `<option value="${l.id}">${l.id}</option>`)
              .join("")
            : `<option value="">No links yet</option>`;
          $("#recordScan").disabled = links.length === 0;
        }
      }
      function renderAnalytics() {
        const scans = db.scans().sort((a, b) => a.ts - b.ts);
        const toDef = scans.length
          ? ymd(scans[scans.length - 1].ts)
          : ymd(Date.now());
        const fromDef = scans.length ? ymd(scans[0].ts) : toDef;
        const inFrom = $("#fFrom"),
          inTo = $("#fTo"),
          inLink = $("#fLink");
        if (!inFrom.value) inFrom.value = fromDef;
        if (!inTo.value) inTo.value = toDef;
        const fromISO = inFrom.value || fromDef,
          toISO = inTo.value || toDef,
          filterLink = inLink.value || "";
        const filtered = scans.filter((s) => {
          const d = ymd(s.ts);
          const okDate = d >= fromISO && d <= toISO;
          const okLink = !filterLink || s.linkId === filterLink;
          return okDate && okLink;
        });

        $("#kpiTotal").textContent = filtered.length.toLocaleString();
        $("#kpiUnique").textContent = new Set(
          filtered.map((s) => s.linkId)
        ).size.toLocaleString();
        $("#kpiLast").textContent = filtered.length
          ? fmtDateTime(filtered[filtered.length - 1].ts)
          : "—";
        const days = Math.max(1, rangeDays(fromISO, toISO).length);
        $("#kpiAvg").textContent = (filtered.length / days).toFixed(1);

        const daysArr = rangeDays(fromISO, toISO);
        const dayCount = Object.fromEntries(daysArr.map((d) => [d, 0]));
        for (const s of filtered)
          dayCount[ymd(s.ts)] = (dayCount[ymd(s.ts)] || 0) + 1;
        drawBars(
          $("#chartTime"),
          daysArr.map((d) => d.slice(5)),
          daysArr.map((d) => dayCount[d] || 0),
          { color: "#6c7dff" }
        );

        const byLink = {};
        for (const s of filtered)
          byLink[s.linkId] = (byLink[s.linkId] || 0) + 1;
        const top = Object.entries(byLink)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 12);
        drawBars(
          $("#chartTop"),
          top.map(([k]) => k),
          top.map(([, v]) => v),
          { color: "#2de6c5" }
        );

        const total = filtered.length || 1;
        const lastByLink = {};
        for (const s of filtered) lastByLink[s.linkId] = s.ts;
        const rows =
          Object.keys(byLink)
            .sort((a, b) => byLink[b] - byLink[a])
            .map((id) => {
              const count = byLink[id],
                share = ((count / total) * 100).toFixed(1) + "%";
              return `<tr><td><code class="code">${id}</code></td><td class="right">${count}</td><td>${fmtDateTime(
                lastByLink[id]
              )}</td><td class="right">${share}</td></tr>`;
            })
            .join("") ||
          `<tr><td colspan="4" class="muted">No scans in this range.</td></tr>`;
        $("#tblLinks tbody").innerHTML = rows;

        refreshAnalyticsSelectors();
      }
      $("#applyFilters").addEventListener("click", renderAnalytics);
      $("#resetFilters").addEventListener("click", () => {
        $("#fFrom").value = "";
        $("#fTo").value = "";
        $("#fLink").value = "";
        renderAnalytics();
      });
      $("#recordScan").addEventListener("click", () => {
        const linkId = $("#scanLinkSelect").value;
        if (!linkId) return alert("Create a link first.");
        logScan({ linkId, source: "studio" });
        renderAnalytics();
      });
      $("#exportScans").addEventListener("click", () => {
        const data = { scans: db.scans() };
        const dl = document.createElement("a");
        dl.download = "qrstudio-scans.json";
        dl.href =
          "data:application/json;charset=utf-8," +
          encodeURIComponent(JSON.stringify(data, null, 2));
        dl.click();
      });
      $("#importScans").addEventListener("click", async () => {
        const f = $("#importScansFile").files?.[0];
        if (!f) return alert("Choose a JSON with {scans:[...]}.");
        const txt = await f.text();
        try {
          const obj = JSON.parse(txt);
          if (!Array.isArray(obj.scans)) throw new Error("No scans[]");
          const merged = db
            .scans()
            .concat(obj.scans)
            .sort((a, b) => a.ts - b.ts);
          db.saveScans(merged);
          renderAnalytics();
          alert("Scans imported.");
        } catch {
          alert("Invalid JSON.");
        }
      });
      $("#clearScans").addEventListener("click", () => {
        if (!confirm("Clear all local scans?")) return;
        db.saveScans([]);
        renderAnalytics();
      });
      $("#genDemo").addEventListener("click", () => {
        const links = db.links();
        if (!links.length) return alert("Create at least one link first.");
        const now = Date.now();
        const days = 14,
          total = 220 + Math.floor(Math.random() * 120);
        const out = db.scans();
        for (let i = 0; i < total; i++) {
          const link = links[Math.floor(Math.random() * links.length)];
          const dayOffset = Math.floor(Math.random() * days);
          const ts =
            now - dayOffset * 86400000 - Math.floor(Math.random() * 86400000);
          const uaPool = [
            "Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X)",
            "Mozilla/5.0 (Linux; Android 13; Pixel 7)",
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 13_5)",
          ];
          const ua = uaPool[Math.floor(Math.random() * uaPool.length)];
          out.push({
            id: uid("scan"),
            linkId: link.id,
            ts,
            ua,
            referrer: "",
            source: "demo",
            device: detectDevice(ua),
          });
        }
        db.saveScans(out);
        renderAnalytics();
      });

      /* ---------- Export / Import themes/links ---------- */
      $("#exportThemes").addEventListener("click", () => {
        const data = { themes: db.themes() };
        const dl = document.createElement("a");
        dl.download = "qrstudio-themes.json";
        dl.href =
          "data:application/json;charset=utf-8," +
          encodeURIComponent(JSON.stringify(data, null, 2));
        dl.click();
      });
      $("#exportLinks").addEventListener("click", () => {
        const data = { links: db.links() };
        const dl = document.createElement("a");
        dl.download = "qrstudio-links.json";
        dl.href =
          "data:application/json;charset=utf-8," +
          encodeURIComponent(JSON.stringify(data, null, 2));
        dl.click();
      });
      function importPayload(obj) {
        if (obj.themes) {
          const byId = Object.fromEntries(db.themes().map((t) => [t.id, t]));
          for (const t of obj.themes) byId[t.id] = t;
          db.saveThemes(Object.values(byId));
        }
        if (obj.links) {
          const byId = Object.fromEntries(db.links().map((l) => [l.id, l]));
          for (const l of obj.links) byId[l.id] = l;
          db.saveLinks(Object.values(byId));
        }
        renderThemesList();
        renderLinksList();
        refreshThemeDropdown();
        drawQR();
      }
      $("#importNow").addEventListener("click", async () => {
        const f = $("#importFile").files?.[0];
        if (!f) return alert("Choose a JSON file first.");
        const txt = await f.text();
        try {
          importPayload(JSON.parse(txt));
          alert("Imported.");
        } catch {
          alert("Invalid JSON.");
        }
      });
      $("#importFromText").addEventListener("click", () => {
        const txt = $("#importText").value.trim();
        if (!txt) return alert("Paste JSON first.");
        try {
          importPayload(JSON.parse(txt));
          alert("Imported.");
        } catch {
          alert("Invalid JSON.");
        }
      });

      /* ---------- Modes (Event / Social) ---------- */
      const MODES_KEY = "qrstudio.uiMode";
      const PLAYLIST_KEY = "qrstudio.social.playlist";
      function getMode() {
        return localStorage.getItem(MODES_KEY) || "event";
      }
      function setMode(m) {
        localStorage.setItem(MODES_KEY, m);
      }
      function getPlaylist() {
        return store.get(PLAYLIST_KEY, []);
      }
      function savePlaylist(arr) {
        store.set(PLAYLIST_KEY, arr);
      }

      function seedPresetsIfEmpty() {
        const themes = db.themes();
        const hasPresets = themes.some((t) => t?.meta?.preset === true);
        if (hasPresets) return;
        const mk = (
          name,
          title,
          subtitle,
          colors,
          ctaText = "Open",
          ctaUrl = ""
        ) => ({
          id: uid("preset"),
          name,
          title,
          subtitle,
          font: "Inter,system-ui",
          colors: {
            bg1: colors[0],
            bg2: colors[1],
            fg: "#f3f6ff",
            ctaBg: colors[2],
            ctaFg: "#09122a",
          },
          cta: { text: ctaText, url: ctaUrl },
          media: { kind: "", data: "", alt: "" },
          settings: {
            redirectDelay: 0,
            showSkip: true,
            skipText: "Skip",
            mediaBox: { w: 320 },
          },
          meta: { preset: true, category: "event" },
        });
        const presets = [
          mk("Welcome", "Welcome Riders!", "Scan for the schedule", [
            "#0f132c",
            "#0b0f23",
            "#6c7dff",
          ]),
          mk("Afterparty", "Afterparty 9PM", "Tap for address", [
            "#2c0f1b",
            "#100810",
            "#ff6b6b",
          ]),
          mk("Sponsor", "Thanks to Our Sponsors", "Exclusive deals inside", [
            "#0f2c23",
            "#0b0f23",
            "#2de6c5",
          ]),
          mk("Merch Drop", "Limited Merch Drop", "Tap to buy now", [
            "#20130f",
            "#0b0f23",
            "#fcbf49",
          ]),
        ];
        db.saveThemes(presets.concat(themes));
      }

      function refreshModeLinkSelect() {
        const links = db.links();
        const sel = $("#modeLinkSelect");
        sel.innerHTML = links.length
          ? links
            .map((l) => `<option value="${l.id}">${l.id}</option>`)
            .join("")
          : `<option value="">No links yet</option>`;
      }
      function applyThemeToLink(linkId, themeId) {
        if (!linkId || !themeId) return;
        const links = db.links();
        const idx = links.findIndex((l) => l.id === linkId);
        if (idx === -1) return;
        links[idx] = { ...links[idx], themeId, updated: Date.now() };
        db.saveLinks(links);
        renderLinksList();
      }
      function el(tag, attrs = {}, html = "") {
        const n = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
          if (k === "class") n.className = v;
          else if (k === "dataset") Object.assign(n.dataset, v);
          else if (k.startsWith("on") && typeof v === "function")
            n.addEventListener(k.slice(2), v);
          else n.setAttribute(k, v);
        }
        if (html) n.innerHTML = html;
        return n;
      }
      function renderPresetsGrid() {
        const mode = getMode();
        const grid = $("#presetsGrid");
        const themes = db.themes();
        const linkId = $("#modeLinkSelect").value;
        const list =
          mode === "event"
            ? themes.filter(
              (t) => t?.meta?.preset === true && t?.meta?.category === "event"
            )
            : themes;
        grid.innerHTML = "";
        if (!list.length) {
          grid.innerHTML = `<div class="muted small">No presets yet. Create themes in Theme Studio.</div>`;
          return;
        }
        list.forEach((t) => {
          const card = el("div", { class: "mode-card" });
          const preview = el(
            "div",
            { class: "preview" },
            t.title ? t.title : "No media"
          );
          preview.style.background = `linear-gradient(140deg, ${t.colors?.bg1 || "#101635"
            }, ${t.colors?.bg2 || "#0b0f23"})`;
          const title = el("div", { class: "t" }, t.name || "Theme");
          const btn = el("button", { class: "btn" });
          if (mode === "event") {
            btn.textContent = "Apply to Link";
            btn.addEventListener("click", () => {
              if (!linkId) {
                alert("Pick an active link first.");
                return;
              }
              applyThemeToLink(linkId, t.id);
            });
          } else {
            btn.textContent = "Add to Playlist";
            btn.addEventListener("click", () => {
              const pl = getPlaylist();
              if (!pl.includes(t.id)) {
                pl.push(t.id);
                savePlaylist(pl);
                renderPlaylist();
              }
            });
          }
          card.append(preview, title, btn);
          grid.appendChild(card);
        });
        $("#modesHeader").textContent =
          mode === "event"
            ? "Event Presets"
            : "Pick Themes for Social Playlist";
      }
      function renderPlaylist() {
        const box = $("#playlist");
        const pl = getPlaylist();
        const themesById = Object.fromEntries(
          db.themes().map((t) => [t.id, t])
        );
        box.innerHTML = "";
        if (!pl.length) {
          box.innerHTML = `<div class="muted small">No items yet. Add some themes on the left.</div>`;
          return;
        }
        pl.forEach((id, idx) => {
          const t = themesById[id];
          const row = el("div", { class: "item small" });
          const left = el(
            "div",
            {},
            `<div><b>${t?.name || "Theme"}</b></div><div class="muted">${t?.title || "—"
            }</div>`
          );
          const actions = el("div", { class: "stack" });
          const up = el("button", { class: "btn ghost" }, "↑");
          const down = el("button", { class: "btn ghost" }, "↓");
          const rem = el("button", { class: "btn warn" }, "Remove");
          up.onclick = () => {
            if (idx === 0) return;
            const arr = getPlaylist();
            [arr[idx - 1], arr[idx]] = [arr[idx], arr[idx - 1]];
            savePlaylist(arr);
            renderPlaylist();
          };
          down.onclick = () => {
            const arr = getPlaylist();
            if (idx >= arr.length - 1) return;
            [arr[idx + 1], arr[idx]] = [arr[idx], arr[idx + 1]];
            savePlaylist(arr);
            renderPlaylist();
          };
          rem.onclick = () => {
            const arr = getPlaylist().filter((x) => x !== id);
            savePlaylist(arr);
            renderPlaylist();
          };
          actions.append(up, down, rem);
          row.append(left, actions);
          box.appendChild(row);
        });
      }
      let rotateTimer = null;
      function setAutorotate(on) {
        if (rotateTimer) {
          clearInterval(rotateTimer);
          rotateTimer = null;
        }
        if (!on) return;
        const sec = Math.max(5, +$("#rotateSec").value || 15);
        rotateTimer = setInterval(() => {
          doNextPreset();
        }, sec * 1000);
      }
      function doNextPreset() {
        const linkId = $("#modeLinkSelect").value;
        const pl = getPlaylist();
        if (!linkId || pl.length === 0) return;
        const arr = pl.slice();
        const nextId = arr.shift();
        arr.push(nextId);
        savePlaylist(arr);
        applyThemeToLink(linkId, nextId);
        renderPlaylist();
      }
      function doRandomPreset() {
        const linkId = $("#modeLinkSelect").value;
        const pl = getPlaylist();
        if (!linkId || pl.length === 0) return;
        const nextId = pl[Math.floor(Math.random() * pl.length)];
        applyThemeToLink(linkId, nextId);
      }
      document.addEventListener("change", (e) => {
        if (e.target && e.target.name === "uimode") {
          setMode(e.target.value);
          renderPresetsGrid();
        }
      });
      $("#nextPreset").addEventListener("click", doNextPreset);
      $("#shufflePreset").addEventListener("click", doRandomPreset);
      $("#autoRotate").addEventListener("change", (e) =>
        setAutorotate(e.target.checked)
      );
      $("#rotateSec").addEventListener("input", () => {
        if ($("#autoRotate").checked) setAutorotate(true);
      });

      /* ---------- Init ---------- */
      function init() {
        refreshThemeDropdown();
        renderThemesList();
        renderLinksList();
        drawQR();
        ensureDraggableQR();
        setOverlayOpacity($("#overlayOpacity").value);
        refreshAnalyticsSelectors();
        seedPresetsIfEmpty();

        // Start at QR tab
        Object.entries(pages).forEach(([k, v]) => (v.hidden = k !== "qr"));
      }
      init();

      function makeResizable(wrapper, { onChange } = {}) {
        const handle = document.createElement("div");
        handle.className = "resizer se";   // ← matches CSS ".resizer.se"
        wrapper.appendChild(handle);

        let startX, startW;

        const move = (e) => {
          const cx = e.touches ? e.touches[0].clientX : e.clientX;
          const newW = Math.max(120, Math.min(wrapper.parentElement.clientWidth, startW + (cx - startX)));
          wrapper.style.width = newW + "px";
          if (onChange) onChange(newW);
        };
        const up = () => {
          document.removeEventListener("mousemove", move);
          document.removeEventListener("mouseup", up);
          document.removeEventListener("touchmove", move);
          document.removeEventListener("touchend", up);
        };
        const down = (e) => {
          e.preventDefault();
          startX = e.touches ? e.touches[0].clientX : e.clientX;
          startW = parseInt(getComputedStyle(wrapper).width, 10) || wrapper.clientWidth;
          document.addEventListener("mousemove", move);
          document.addEventListener("mouseup", up);
          document.addEventListener("touchmove", move, { passive: false });
          document.addEventListener("touchend", up);
        };

        handle.addEventListener("mousedown", down);
        handle.addEventListener("touchstart", down, { passive: false });
      }
  </script>
</body>

</html>