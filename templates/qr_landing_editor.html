<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ThemeQR - Dynamic Redirect QR</title>
  <link rel="icon" href="https://themeqr.com/images/TQR_Dude_Sm.png">
  <link rel="stylesheet" href="https://themeqr.com/static/css/styles.css">
</head>
<body>
<header>
  <h1>ThemeQR Dynamic Redirect</h1>
  <p>This QR code always points to <strong>https://themeqr.com/go.html</strong></p>
  <div class="auth-controls" id="user-nav">
    {% if user %}
      <span>Hello, {{ user.email }}!</span>
      <a href="{{ url_for('logout') }}" class="logout-btn">Log Out</a>
    {% else %}
      <span>Please log in to manage QR codes.</span>
    {% endif %}
  </div>
</header>

<section class="section">
  <h2>üîó Choose or Enter a New Destination</h2>
  <button class="btn" id="amazonBtn" disabled onclick="changeQrLanding('https://www.amazon.com')">Amazon</button>
  <button class="btn" id="walmartBtn" disabled onclick="changeQrLanding('https://www.walmart.com')">Walmart</button>
  <button class="btn" id="themeQrBtn" disabled onclick="changeQrLanding('https://themeqr.com')">Reset to ThemeQR</button>
 
  <p style="margin-top:2rem;"><strong>Or enter a custom URL:</strong></p>
  <input type="url" id="customUrl" placeholder="https://example.com" />
  <br/>
  <button class="btn" onclick="customSubmit()">Submit</button>
</section>

<section class="section">
  <div>
    <h2>üåê Curious about how our Themes?</h2>
    <a href="https://themeqr-backend.onrender.com/manager" class="btn">Click Here!</a>
  </div>
  <h2>üì∑ Scan Here!</h2>
  <div id="deckButtons"></div>
  <img class="qr" id="qrImg" src="https://themeqr-backend.onrender.com/static/themeqr_go_html_qr.png" alt="QR Code">
  <p id="status"></p>
  <button class="btn" onclick="resetQrToDefault()">Reset to Default QR</button>
</section>

<footer class="footer">
  ¬© 2025 ThemeQR. All rights reserved.
</footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "{{ supabase_url }}";
  const SUPABASE_KEY = "{{ supabase_key }}";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  console.log("Using Supabase URL:", SUPABASE_URL);
  console.log("Template User (raw):", "{{ user | tojson | safe }}");
  let currentUser;
  try {
    currentUser = {{ user | tojson | safe }} || null;
    console.log("Parsed currentUser:", currentUser);
  } catch (e) {
    console.error("Error parsing currentUser:", e);
    currentUser = null;
  }

  window.currentDeckId = null;

  async function fetchUserVaultAndDecks(userId) {
    try {
      console.log("Fetching vaults and decks for user:", userId);
      const { data: vaultData, error: vaultError } = await supabase
        .from('vaults')
        .select('id')
        .eq('user_id', userId)
        .single();
      if (vaultError || !vaultData) throw new Error('Vault not found: ' + (vaultError?.message || 'No data'));

      const vaultId = vaultData.id;
      console.log("Fetched vault ID:", vaultId);

      const { data: deckData, error: deckError } = await supabase
        .from('decks')
        .select('id, deck_name')
        .eq('vault_id', vaultId);
      if (deckError || !deckData.length) throw new Error('No decks found: ' + (deckError?.message || 'No data'));

      return { vaultId, decks: deckData };
    } catch (error) {
      console.error('Error fetching user vault and decks:', error);
      updateStatus(`‚ùå ${error.message}`, true);
      return { vaultId: null, decks: [] };
    }
  }

  function populateDeckButtons(decks) {
    const deckButtonsDiv = document.getElementById('deckButtons');
    deckButtonsDiv.innerHTML = '';
    console.log("Decks received:", decks); // Debug log
    if (decks.length > 0) {
      decks.forEach(deck => {
        const button = document.createElement('button');
        button.className = 'btn deck-btn';
        button.textContent = deck.deck_name;
        button.dataset.deckId = deck.id;
        button.onclick = () => selectDeck(deck.id, deck.deck_name);
        deckButtonsDiv.appendChild(button);
      });
      document.getElementById('amazonBtn').disabled = false;
      document.getElementById('walmartBtn').disabled = false;
      document.getElementById('themeQrBtn').disabled = false;
    } else {
      deckButtonsDiv.innerHTML = '<p>No decks available. Please create a deck or contact support.</p>';
    }
  }

  function selectDeck(deckId, deckName) {
    window.currentDeckId = deckId;
    const vaultId = "{{ vault_id | default('') | safe }}";
    console.log("Selected deck:", deckId, "with vaultId:", vaultId);
    if (vaultId) {
      const qrImageName = `${vaultId}_${deckName}_qr.png`;
      const qrImg = document.getElementById('qrImg');
      const qrUrl = `https://themeqr-backend.onrender.com/static/${qrImageName}?t=${new Date().getTime()}`;
      const img = new Image();
      img.onload = () => {
        qrImg.src = qrUrl;
        updateStatus(`‚úÖ QR code updated for ${deckName}`, false);
      };
      img.onerror = () => {
        qrImg.src = 'https://themeqr-backend.onrender.com/static/themeqr_go_html_qr.png';
        updateStatus(`‚ùå QR code for ${deckName} not found, using default`, true);
      };
      img.src = qrUrl;
    } else {
      updateStatus('‚ùå No vault ID available', true);
    }
  }

  async function changeQrLanding(landingUrl) {
    if (!window.currentDeckId) {
      updateStatus('‚ùå No deck selected', true);
      return;
    }
    try {
      console.log("Changing landing URL to:", landingUrl, "for deck:", window.currentDeckId);
      const response = await fetch('/change_qr_landing', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ landing: landingUrl, deck_id: window.currentDeckId })
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`HTTP error ${response.status}: ${errorText}`);
        throw new Error(`HTTP error ${response.status}: ${errorText}`);
      }
      const data = await response.json();
      console.log('Success:', data);
      if (data.success) {
        updateStatus(`‚úÖ Landing URL updated to ${landingUrl} for selected deck`, false);
      }
    } catch (error) {
      console.error('Fetch error:', error);
      updateStatus(`‚ùå Failed to update URL: ${error.message}`, true);
    }
  }
  window.changeQrLanding = changeQrLanding;

  function resetQrToDefault() {
    const qrImg = document.getElementById('qrImg');
    qrImg.src = 'https://themeqr-backend.onrender.com/static/themeqr_go_html_qr.png';
    window.currentDeckId = '{{ DEMO_DECK_ID | default("71f42d9b-fe22-4085-87f0-944ab85ac07e") | safe }}';
    console.log("Reset to default deck:", window.currentDeckId);
    changeQrLanding('https://themeqr-backend.onrender.com/static/themeqr_go_html_qr.png')
      .catch(error => console.error('Reset error:', error));
  }
  window.resetQrToDefault = resetQrToDefault;

  document.getElementById('qr-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const landingUrl = document.getElementById('landing-url').value;
    await changeQrLanding(landingUrl).catch(error => console.error('Form submit error:', error));
  });

  function customSubmit() {
    const customUrlInput = document.getElementById('customUrl');
    if (customUrlInput && customUrlInput.value) {
      const landingUrl = customUrlInput.value;
      updateStatus("Updating URL...", false);
      changeQrLanding(landingUrl)
        .catch(error => console.error('Custom submit error:', error));
    } else {
      updateStatus("Please enter a custom URL.", true);
    }
  }
  window.customSubmit = customSubmit;

  function generateQr() {
    if (!window.currentDeckId) {
      updateStatus('‚ùå No deck selected', true);
      return;
    }
    console.log("Generating QR for deck:", window.currentDeckId);
    fetch('/generate_qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ link: 'https://themeqr.com/go', deck_id: window.currentDeckId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const qrImg = document.getElementById('qrImg');
        qrImg.src = data.qr_url + '?t=' + new Date().getTime();
        updateStatus("‚úÖ Curious? Scan Here!!!", false);
      } else {
        updateStatus(`‚ùå ${data.error}`, true);
      }
    })
    .catch(err => updateStatus(`‚ùå Network error: ${err.message}`, true));
  }

  function updateStatus(msg, isError = false) {
    const el = document.getElementById('status');
    el.innerText = msg;
    el.style.color = isError ? 'red' : 'green';
  }

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOM Loaded, starting authentication check');
    console.log('Template User (raw):', "{{ user | tojson | safe }}");
    console.log('Template Vault ID:', "{{ vault_id | default('') | safe }}" || "None");
    try {
      let currentUser = {{ user | tojson | safe }} || null;
      console.log('Parsed currentUser:', currentUser);

      if (currentUser && currentUser.id) {
        console.log('User found, checking session:', currentUser.id);
        const { data: session, error: sessionError } = await supabase.auth.getSession();
        console.log('Client Session:', session);
        if (sessionError) console.error('Session error:', sessionError);
        if (session?.session) {
          console.log('Session valid, fetching vaults and decks');
          const { vaultId, decks } = await fetchUserVaultAndDecks(currentUser.id).catch(error => console.error('Vault fetch error:', error));
          if (vaultId) {
            populateDeckButtons(decks);
            const qrImg = document.getElementById('qrImg');
            qrImg.src = 'https://themeqr-backend.onrender.com/static/themeqr_go_html_qr.png';
            updateStatus('‚úÖ Select a deck to update the QR code', false);
          } else {
            console.log('No vaultId, using demo deck');
            resetQrToDefault();
          }
        } else {
          console.log('No valid session despite user, forcing login');
          updateStatus('‚ùå Session invalid, please log in', true);
        }
      } else {
        console.log('No template user, falling back to client session');
        const { data: session, error: sessionError } = await supabase.auth.getSession();
        console.log('Fallback Session:', session);
        if (sessionError) console.error('Fallback Session error:', sessionError);
        if (session?.session) {
          const user = session.session.user;
          console.log('Fallback user found:', user.id);
          const { vaultId, decks } = await fetchUserVaultAndDecks(user.id).catch(error => console.error('Vault fetch error:', error));
          if (vaultId) {
            populateDeckButtons(decks);
            const qrImg = document.getElementById('qrImg');
            qrImg.src = 'https://themeqr-backend.onrender.com/static/themeqr_go_html_qr.png';
            updateStatus('‚úÖ Select a deck to update the QR code', false);
          } else {
            console.log('No vaultId in fallback, using demo deck');
            resetQrToDefault();
          }
        } else {
          console.log('No fallback session, requiring login');
          updateStatus('‚ùå Please log in to view decks and QR codes', true);
        }
      }
    } catch (e) {
      console.error('Error in DOMLoaded:', e);
      updateStatus('‚ùå An error occurred, please try again', true);
    }
  });
</script>
</body>
</html>