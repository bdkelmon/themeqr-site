<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ThemeQR - Dynamic Redirect QR</title>
  <link rel="icon" href="https://themeqr.com/images/TQR_Dude_Sm.png">
  <link rel="stylesheet" href="https://themeqr.com/static/css/styles.css">
</head>
<body>
<header>
  <h1>ThemeQR Dynamic Redirect</h1>
  <p>This QR code always points to <strong>https://themeqr.com/go.html</strong></p>
  <div class="auth-controls" id="user-nav">
    {% if user %}
      <span>Hello, {{ user.email }}!</span>
      <a href="{{ url_for('logout') }}" class="logout-btn">Log Out</a>
    {% else %}
      <span>Please log in to manage QR codes.</span>
    {% endif %}
  </div>
</header>

<section class="section">
  <h2>üîó Choose or Enter a New Destination</h2>
  <button class="btn" onclick="changeQrLanding('https://www.amazon.com')">Amazon</button>
  <button class="btn" onclick="changeQrLanding('https://www.walmart.com')">Walmart</button>
  <button class="btn" onclick="changeQrLanding('https://themeqr.com')">Reset to ThemeQR</button>
  <p style="margin-top:2rem;"><strong>Or enter a custom URL:</strong></p>
  <input type="url" id="customUrl" placeholder="https://example.com" />
  <br/>
  <button class="btn" onclick="customSubmit()">Submit</button>
</section>

<section class="section">
  <div>
    <h2>üåê Curious about how our Themes?</h2>
    <a href="https://themeqr-backend.onrender.com/manager" class="btn">Click Here!</a>
  </div>
  <h2>üì∑ Scan Here!</h2>
  <div id="deckButtons"></div>
  <img class="qr" id="qrImg" src="https://themeqr-backend.onrender.com/static/themeqr_go_html_qr.png" alt="QR Code">
  <p id="status"></p>
</section>

<footer class="footer">
  ¬© 2025 ThemeQR. All rights reserved.
</footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "{{ supabase_url }}";
  const SUPABASE_KEY = "{{ supabase_key }}";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  console.log("Using Supabase URL:", SUPABASE_URL);

  let currentDeckId = null;

  async function fetchUserVaultAndDecks(userId) {
    try {
      // Fetch vault_id from vaults table using user_id
      const { data: vaultData, error: vaultError } = await supabase
        .from('vaults')
        .select('id')
        .eq('user_id', userId)
        .single();
      if (vaultError || !vaultData) throw new Error('Vault not found: ' + (vaultError?.message || 'No data'));

      const vaultId = vaultData.id;

      // Fetch deck names from decks table using vault_id
      const { data: deckData, error: deckError } = await supabase
        .from('decks')
        .select('id, deck_name')
        .eq('vault_id', vaultId);
      if (deckError || !deckData.length) throw new Error('No decks found: ' + (deckError?.message || 'No data'));

      return { vaultId, decks: deckData };
    } catch (error) {
      console.error('Error fetching user vault and decks:', error);
      updateStatus(`‚ùå ${error.message}`, true);
      return { vaultId: null, decks: [] };
    }
  }

  function populateDeckButtons(decks) {
    const deckButtonsDiv = document.getElementById('deckButtons');
    deckButtonsDiv.innerHTML = '';
    if (decks.length > 0) {
      decks.forEach(deck => {
        const button = document.createElement('button');
        button.className = 'btn deck-btn';
        button.textContent = deck.deck_name;
        button.dataset.deckId = deck.id;
        button.onclick = () => selectDeck(deck.id, deck.deck_name);
        deckButtonsDiv.appendChild(button);
      });
    } else {
      deckButtonsDiv.innerHTML = '<p>No decks available.</p>';
    }
  }

  function selectDeck(deckId, deckName) {
    currentDeckId = deckId;
    const vaultId = '{{ vault_id }}'; // Passed from app.py
    if (vaultId) {
      const qrImageName = `${vaultId}_${deckName}_qr.png`;
      const qrImg = document.getElementById('qrImg');
      const qrUrl = `https://themeqr-backend.onrender.com/static/${qrImageName}?t=${new Date().getTime()}`;
      // Check if the image exists by creating an Image object
      const img = new Image();
      img.onload = () => {
        qrImg.src = qrUrl;
        updateStatus(`‚úÖ QR code updated for ${deckName}`, false);
      };
      img.onerror = () => {
        qrImg.src = 'https://themeqr-backend.onrender.com/static/themeqr_go_html_qr.png';
        updateStatus(`‚ùå QR code for ${deckName} not found, using default`, true);
      };
      img.src = qrUrl; // Trigger the load check
    } else {
      updateStatus('‚ùå No vault ID available', true);
    }
  }

  async function changeQrLanding(landingUrl) {
    try {
      const response = await fetch('https://themeqr-backend.onrender.com/change_qr_landing', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ landing: landingUrl, deck_id: currentDeckId })
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`HTTP error ${response.status}: ${errorText}`);
        throw new Error(`HTTP error ${response.status}: ${errorText}`);
      }
      const data = await response.json();
      console.log('Success:', data);
      generateQr();
      return data;
    } catch (error) {
      console.error('Fetch error:', error);
      updateStatus("‚ùå Failed to update URL: " + error.message, true);
      throw error;
    }
  }
  window.changeQrLanding = changeQrLanding;

  document.getElementById('qr-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const landingUrl = document.getElementById('landing-url').value;
    await changeQrLanding(landingUrl);
  });

  function customSubmit() {
    const customUrlInput = document.getElementById('customUrl');
    if (customUrlInput && customUrlInput.value) {
      const landingUrl = customUrlInput.value;
      updateStatus("Updating URL...", false);
      changeQrLanding(landingUrl)
        .catch(error => {});
    } else {
      updateStatus("Please enter a custom URL.", true);
    }
  }
  window.customSubmit = customSubmit;

  function generateQr() {
    if (!currentDeckId) {
      updateStatus('‚ùå No deck selected', true);
      return;
    }
    fetch('https://themeqr-backend.onrender.com/generate_qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ link: 'https://themeqr.com/go', deck_id: currentDeckId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const qrImg = document.getElementById('qrImg');
        qrImg.src = data.qr_url + '?t=' + new Date().getTime();
        updateStatus("‚úÖ Curious? Scan Here!!!", false);
      } else {
        updateStatus("‚ùå " + data.error, true);
      }
    })
    .catch(err => updateStatus("‚ùå Network error: " + err.message, true));
  }

  function updateStatus(msg, isError = false) {
    const el = document.getElementById('status');
    el.innerText = msg;
    el.style.color = isError ? 'red' : 'green';
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const currentUser = {{ user | tojson }}; // Renamed to avoid redeclaration
    if (currentUser && currentUser.id) {
      const { vaultId, decks } = await fetchUserVaultAndDecks(currentUser.id);
      if (vaultId) {
        populateDeckButtons(decks);
        // Set default QR image without selecting a deck
        const qrImg = document.getElementById('qrImg');
        qrImg.src = 'https://themeqr-backend.onrender.com/static/themeqr_go_html_qr.png';
        updateStatus('‚úÖ Select a deck to update the QR code', false);
      }
    } else {
      updateStatus('‚ùå Please log in to view decks and QR codes', true);
    }
  });
</script>
</body>
</html>